<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Dashboard</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.0.1/spin.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.5/leaflet.js"></script>
    <script src="https://api.mapbox.com/mapbox.js/v3.3.0/mapbox.js"></script>
    <script src="https://d3js.org/d3-queue.v3.min.js"></script>
    <link
      href="https://api.mapbox.com/mapbox.js/v3.2.1/mapbox.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <script src="https://cdn.rawgit.com/eligrey/canvas-toBlob.js/f1a01896135ab378aa5c0118eadd81da55e698d8/canvas-toBlob.js"></script>
    <script src="https://cdn.rawgit.com/eligrey/FileSaver.js/e9d941381475b5df8b7d7691013401e171014e89/FileSaver.min.js"></script>
        <script
      src="https://kit.fontawesome.com/ea2379d57d.js"
      crossorigin="anonymous"
    ></script>
    <link rel="icon" href="assets/favicon.ico">
    <style type="text/css">
      body {
        display: grid;
        grid-template-columns: 146px 800px 160px 200px;
        grid-template-rows: 300px 120px 400px;
        grid-gap: 0.1em;
        margin: auto;
      }

      #chart-container {
        position: fixed;
        top: 0px;
        left: 146px;
      }

      #key-container {
        position: fixed;
        overflow: hidden;
      }

      #control-container {
        position: fixed;
        overflow: hidden;
        padding: 10px 20px;
        text-align: center;
      }

      #save-button-container {
        margin-top: 30px;
        text-align: center;
      }

      @font-face {
        font-family: "Graphik Regular";
        font-style: normal;
        font-weight: normal;
        src: local("Graphik Regular"), url("GraphikRegular.woff") format("woff");
      }

      @font-face {
        font-family: "Graphik Bold";
        font-style: normal;
        font-weight: bold;
        src: local("Graphik Bold"), url("GraphikBold.woff") format("woff");
      }

      .segment {
        stroke: white;
        stroke-width: 2px;
      }

      .mature-segments {
        fill: #f4f4f4;
      }

      .emerging-segments {
        fill: #e9e9e9;
      }

      .nascent-segments {
        fill: #dfdfdf;
      }

      .segment-band {
        stroke: white;
        stroke-width: 2px;
      }

      .opp-space-label-text {
        fill: white;
        text-anchor: middle;
        font-weight: bold;
        font-size: 10px;
        font-family: "Graphik Bold";
      }

      .label-text {
        fill: white;
        text-anchor: middle;
        font-weight: bold;
        font-size: 10px;
        font-family: "Graphik Bold";
      }

      .theme-label-text {
        fill: white;
        text-anchor: middle;
        font-weight: bold;
        font-size: 10px;
        font-family: "Graphik Bold";
      }

      .labels-theme-text {
        fill: white;
        text-anchor: middle;
        font-weight: bold;
        font-size: 10px;
        font-family: "Graphik Bold";
      }

      .funding-hover-info {
        fill: black;
        text-anchor: middle;
        font-weight: bold;
        font-size: 10px;
        font-family: "Graphik Regular";
        pointer-events: none;
      }

      .funding-hover-info.amount {
        font-size: 12px;
      }

      .funding-hover-info.title {
        font-size: 12px;
        font-family: "Graphik Bold";
      }

      .year-labels {
        fill: #8b8b8b;
        text-anchor: middle;
        font-size: 8px;
        font-family: "Graphik Bold";
      }

      .maturity-labels {
        fill: #8b8b8b;
        text-anchor: middle;
        font-size: 8px;
        font-family: "Graphik Bold";
      }

      .nodes {
        stroke: black;
        stroke-width: 1px;
      }

      .wrap-header {
        font-family: "Graphik Bold";
        font-weight: bold;
      }

      #chart-container {
        text-align: center;
      }

      .node-mouse-over-box {
        pointer-events: none;
      }

      .node-mouse-over-text {
        font-size: 10px;
        text-anchor: start;
        font-weight: bold;
        fill: #404e4d;
        font-family: "Graphik Regular";
        pointer-events: none;
        width: 100px;
      }

      .chart-title {
        font-family: "Graphik Bold";
        font-weight: bold;
        text-anchor: middle;
        font-size: 28px;
      }

      .key-label {
        font-family: "Graphik Regular";
        font-size: 10px;
        cursor: pointer;
      }

      .key-item {
        stroke: black;
        stroke-width: 1px;
        fill: white;
        cursor: pointer;
      }

      .key-item-other {
        stroke: black;
        stroke-width: 1px;
        cursor: pointer;
      }

      .key-title {
        font-weight: bold;
        font-family: "Graphik Bold";
        font-size: 12px;
      }

      .segment-band {
        cursor: pointer;
      }

      #switch-button {
        cursor: pointer;
        background-color: #8e8e8e;
        color: #faf0e6;
        padding: 10px;
        font-family: "Graphik Regular";
        font-size: 10px;
        border: none;
        cursor: pointer;
        text-anchor: middle;
        min-width: 100px;
      }

      #switch-button:hover {
        background-color: #247DC5;
      }

      #switch-button-label {
        font-weight: bold;
        font-family: "Graphik Regular";
        font-size: 10px;
        text-anchor: middle;
        pointer-events: none;
      }

      /* Dropdown Button */
      .dropbtn {
        background-color: #787878;
        color: white;
        padding: 10px;
        font-family: "Graphik Regular";
        font-weight: bold;
        font-size: 10px;
        border: none;
        cursor: pointer;
        min-width: 130px;
        text-anchor: middle;
      }

      /* The container <div> - needed to position the dropdown content */
      .dropdown-client {
        margin: auto;
        position: relative;
        display: none;
        text-anchor: middle;
      }

      /* Dropdown Content (Hidden by Default) */
      .dropdown-content {
        display: none;
        position: absolute;
        background-color: #f1f1f1;
        min-width: 130px;
        z-index: 1;
        max-height: 530px;
        overflow: auto;
        text-anchor: middle;
      }

      /* Links inside the dropdown */
      .dropdown-content a {
        color: #404e4d;
        font-size: 10px;
        font-family: "Graphik Regular";
        font-weight: bold;
        padding: 8px 0px;
        text-decoration: none;
        display: block;
        text-anchor: middle;
        text-align: center;
      }

      /* Change color of dropdown links on hover */
      .dropdown-content a:hover {
        background-color: #ddd;
      }

      /* Show the dropdown menu on hover */
      .dropdown-client:hover .dropdown-content {
        display: block;
      }

      .dropdown-league:hover .dropdown-content {
        display: block;
      }

      /* Change the background color of the dropdown button when the dropdown content is shown */
      .dropdown-client:hover .dropbtn {
        background-color: #247DC5;
      }

      .switch-button {
        cursor: pointer;
        color: white;
        padding: 10px;
        font-family: "Graphik Regular";
        font-size: 10px;
        border: none;
        cursor: pointer;
        text-anchor: middle;
        width: 130px;
        font-weight: bold;
      }

      .switch-button-label {
        font-weight: bold;
        font-family: "Graphik Regular";
        font-size: 10px;
        text-anchor: middle;
        pointer-events: none;
      }

      #map-button,
      #save-button {
        background-color: #787878;
        display: none;
      }

      #map-button:hover,
      #save-button:hover {
        background-color: #247DC5;
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
      }

      /* Hide default HTML checkbox */
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      /* The slider */
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #8e8e8e;
        -webkit-transition: 0.4s;
        transition: 0.4s;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        -webkit-transition: 0.4s;
        transition: 0.4s;
      }

      input:checked + .slider {
        background-color: #ea3b66;
      }

      input:focus + .slider {
        box-shadow: 0 0 1px #ea3b66;
      }

      input:checked + .slider:before {
        -webkit-transform: translateX(26px);
        -ms-transform: translateX(26px);
        transform: translateX(26px);
      }

      .toggle-button-cover {
        display: table-cell;
        position: relative;
        width: 300px;
        height: 140px;
        box-sizing: border-box;
      }

      .button-cover {
        height: 100px;
        margin: 20px;
        background-color: #fff;
        box-shadow: 0 10px 20px -8px #c5d6d6;
        border-radius: 4px;
      }

      .button-cover:before {
        counter-increment: button-counter;
        content: counter(button-counter);
        position: absolute;
        right: 0;
        bottom: 0;
        color: #d7e3e3;
        font-size: 12px;
        line-height: 1;
        padding: 5px;
      }

      .button-cover,
      .knobs,
      .layer {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }

      .button {
        position: relative;
        top: 50%;
        width: 130px;
        height: 36px;
        margin: 0px auto 0 auto;
        overflow: hidden;
      }

      .button.r,
      .button.r .layer {
        border-radius: 100px;
      }

      .button.b2 {
        border-radius: 1px;
      }

      .checkbox {
        position: relative;
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
        opacity: 0;
        cursor: pointer;
        z-index: 3;
      }

      .knobs {
        z-index: 2;
      }

      .layer {
        width: 100%;
        background-color: #ebf7fc;
        transition: 0.8s ease all;
        z-index: 1;
      }

        #button-17,
      #button-16 {
        display: none;
      }

      #button-16 .knobs:before {
        content: "Year";
        position: absolute;
        top: 4px;
        left: 4px;
        width: 60px;
        height: 10px;
        color: #fff;
        font-size: 10px;
        font-family: "Graphik Regular";
        font-weight: bold;
        text-align: center;
        line-height: 1;
        padding: 9px 4px;
        background-color: #5fbdfb;
        border-radius: 2px;
        transition: 0.8s ease all,
          left 0.8s cubic-bezier(0.18, 0.89, 0.35, 1.15);
      }

      #button-17 .knobs:before {
        content: "Global";
        position: absolute;
        top: 4px;
        left: 4px;
        width: 60px;
        height: 10px;
        color: #fff;
        font-size: 10px;
        font-family: "Graphik Regular";
        font-weight: bold;
        text-align: center;
        line-height: 1;
        padding: 9px 4px;
        background-color: #5fbdfb;
        border-radius: 2px;
        transition: 0.8s ease all,
          left 0.8s cubic-bezier(0.18, 0.89, 0.35, 1.15);
      }

      #button-17 .checkbox:checked + .knobs:before {
        content: "Africa";
        left: 56px;
        background-color: #ea3b66;
      }

      #button-17 .checkbox:active + .knobs:before,
      #button-16 .checkbox:active + .knobs:before {
        width: 46px;
      }

      #button-17
        .checkbox:checked:active
        + .knobs:before
        #button-16
        .checkbox:checked:active
        + .knobs:before {
        margin-left: -26px;
      }

      #button-16 .checkbox:checked + .knobs:before {
        content: "Maturity";
        left: 56px;
        background-color: #ea3b66;
      }

      #button-17 .checkbox:checked ~ .layer,
      #button-16 .checkbox:checked ~ .layer {
        background-color: #fcebeb;
      }

      i {
        border: solid white;
        border-width: 0 2px 2px 0;
        display: inline-block;
        padding: 2px;
      }

      .down {
        transform: rotate(45deg);
        -webkit-transform: rotate(45deg);
      }

      #map {
      position: relative;
      outline: none;
      overflow: hidden;
      height: 100%; 
      }

      .bg {
        background-color: #F4F4F4;
        position: absolute;
        top: 0px;
        left: 0px;
        height: 100%;
        width: 100%;
        z-index: -1;
      }

      .country {
        stroke-width: 1.5px;
        stroke: #cbcbcb;
      }

      .sidebar {
        position: fixed;
        width: 380px;
        height: 100vh;
        background-color: #F4F4F4;
        border-left: 2px solid #DCDCDC;
        right: 0px;
        top: 0px;
        z-index: 100;
      }

      .city-circle,
      .country-circle {
        fill-opacity: 0.3;
        stroke-width: 3px;
      }

      #chart-button {
        background-color: #787878;
        position: absolute;
        left: 150px;
        top: 700px;
      }

      #chart-button:hover {
        background-color: #247DC5;
      }

      .map-tooltip {
        background-color: #383838;
        border: 1px solid black;
        font-weight: bold;
        font-family: "Graphik Regular";
        font-size: 14px;
        border-radius: 10px;
        min-width: 100px;
        text-align: center;
        color: white;
        position: absolute;
        padding: 10px;
      }

      .sidebar-title {
        font-weight: bold;
        font-family: "Graphik Bold";
        text-align: center;
        font-size: 36px;
        padding-top: 60px;
        padding-bottom: 20px;
        text-transform: uppercase;
        color: #787878;
      }

      #startup-list {
        padding: 40px;
        max-height: 300px;
        overflow: scroll;
      }

      .startup-table {
        min-width: 300px;
        max-height: 300px;
        overflow: scroll;
        font-family: "Graphik Regular";
        background-color: white;
        color: #313131;
        padding: 10px;
        border: 2px solid #313131;
      }

      .startup-table tr {
        font-size: 12px;
        height: 25px;
      }

      .startup-table td {
        min-width: 60px;
      }

      .startup-table td > a {
        color: #313131;
      }

      .table-header {
        font-family: "Graphik Bold";  
      }

      .left-sidebar {
          align-items: center;
          justify-content: center;
              overflow: hidden;
          position: fixed;
            width: 146px;
            height: 100vh;
            left: 0px;
            top: 0px;
            background-color: #F4F4F4;
            border-right: 2px solid #DCDCDC;
            font-family: "Graphik Bold";  
            vertical-align: middle;
            text-align: center;
            text-anchor: middle;
      }

      .left-sidebar-header {
            width: 100%;
    height: 96px;
    display: flex;
    position: relative;
    align-items: center;
    justify-content: center;
      }

      .compass-title {
        font-size: 12px;
        width: 96px;
        text-align: center;
        color: #787878;
        margin: auto;
      }

      .left-sidebar-header img {
        width: 100px;
        object-fit: contain;
      }

      .left-sidebar-buttons {
        top: 25%;
        position: relative;
      }

      .left-sidebar-btn {
        font-size: 18px;
        width: 96px;
        cursor: pointer;
        height: 96px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column-reverse;
        color: #C3C3C3;
        margin: auto;
      }

      .left-sidebar-btn > i {
        border: 0px;
      }

      .left-sidebar-btn-label {
        margin-top: 5px;
        font-size: 10px;
      }

      .left-sidebar-btn.active {
        color: #313131;
    }

    .popup-bg {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      z-index: 9999;
      position: fixed;
      top: 0px;
      left: 0px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(0,0,0,0.4);
    }

    .popup-container {
      opacity: 1;
      bottom: 300%;
      border-top-left-radius: 30px;
    border-top-right-radius: 30px;
    width: 92vw;
    height: 92%;
    position: absolute;
    z-index: 33333;
    background: white;
    padding-top: 30px;
    align-items: center;
    justify-content: center;
    overflow: scroll;
    }

    .popup-container.added {
      bottom: 0px;
  }

  .analysis-btn {
    position: relative;
    top: 0vh;
    margin: 0 auto;
    font-size: 24px;
    width: 96px;
    cursor: pointer;
    height: 96px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column-reverse;
    color: #36363c
  }

  .analysis-btn:hover {
    font-size: 30px;
  }

  .popup-analysis-label {
    font-size: 14px;
    font-family: "Graphik Bold";
    margin-bottom: 5px;
  }

  .popup-close {
    position: relative;
    top: -20px;
    left: 87.4vw;
    font-size: 22px;
    display: inline;
    cursor: pointer;
    align-items: center;
    justify-content: center;
    color: #36363c
  }

  .popup-tag {
    position: relative;
    top: 5px;
    font-family: "Graphik Bold";
    font-size: 12px;
    margin-left: 35px;
    color: #36363c;
    text-transform: capitalize;
  }

  .popup-tag-item {
    display: inline;
    background-color: #E6E6E6;
    border-radius: 2px;
    padding: 6px;
    
  }

  .popup-tag-item-arr {
    display: inline;
    padding-left: 10px;
    padding-right: 10px;
    
  }

  .column {
    float: left;
    padding: 0px;
    margin: 5px;
    height: 76vh;
    margin-top: 0px;
    margin-bottom: 0px;
  }

  .left {
    width: 35%;
    margin-left: 35px;
  }

  .right {
    width: 58%;
    margin-right: 35px;
  }

  .popup-section-a:after {
    content: "";
    display: table;
    clear: both;
  }

  .svg-container {
    margin: auto;
    margin-bottom: 30px;
  }

  .opportunity-space-title {
    font-family: "Graphik Bold";
    text-transform: capitalize;
    background-color: #E6E6E6;
    border-radius: 2px;
    padding: 6px;
    font-size: 12px;
    display: inline-block;
    color: #36363c
  }

  .opportunity-space-description {
    font-size: 12px;
    color: #36363c;
    margin: 10px;
    font-family: "Graphik Regular";
    margin-bottom: 15px;
    margin-right: 15px;
    
  }

  .opportunity-space-summary-row {
    height: 26px;
    width: 100%;
    border: 1px solid white;;
  }

  .column-value {
    font-family: "Graphik Regular";
    font-size: 12px;
  }

  .column-icon {
    display: inline;
    margin: auto;
    min-width: 26px;
  }

  .column-icon > i {
    border: 0px;
    color: #36363c;
    width: 26px;
    margin: auto;
    text-align: center;
  }

  .column-desc {
    font-size: 12px;
    color: #36363c;
    font-family: "Graphik Regular";
    display: inline;
  }

  .column-value {
    display: inline;
  }

  .right-title {
    font-size: 30px;
    color: #36363c;
    font-family: "Graphik Bold";
    margin-bottom: 15px;
  }

  .hero-startup {
    margin-bottom: 15px;
    color: #36363c;
  }

  .hero-startup-container {
    padding: 10px;
    height: 150px;
  }

  .hero-startup-number {
    float: left;
    color: #36363c;
    font-size: 20px;
    font-family: "Graphik Bold";
    border-radius: 30px;
    background-color: #E6E6E6;
    text-align: center;
    width: 1.6em; 
    margin-right: 15px;
    line-height: 1.6em;
  }

  .fl {
      float: left;
  }

  .hero-startup-logo-container {
    display:table-cell;
    padding: 5px;
        padding-top: 0px;
        padding-bottom: 0px;
        max-width: 140px;
    text-align: center; 
    vertical-align: middle;
  }

  .hero-startup-logo {
      margin: auto;
    width: 110px;
  }

  .hero-startup-desc {
        float: left;
        width: 60%;
    font-family: "Graphik Regular";
    font-size: 12px;
    padding: 5px;
  }

  .hero-startup-stats {
        float: left;
        width: 25%;
    font-family: "Graphik Regular";
    font-size: 12px;
    padding: 5px;
    margin-bottom: 20px;
  }

  .hero-startup-desc-overview {
    margin-bottom: 5px;
  }

  .hero-startup-desc-problem {
    margin-bottom: 5px;
  }

  .hero-startup-stats-website {
    margin-bottom: 5px;
  }

  .hero-startup-stats-Country {
    margin-bottom: 5px;
  }

  .hero-startup-stats-round {
    margin-bottom: 5px;
  }

  .hero-startup-stats-amount {
    margin-bottom: 5px;
  }

  .popup-section-b {
    padding: 10px;
    margin: 20px;
    margin-bottom: 10px;
    height: 70vh;
  }

  .bar-chart-title {
    font-size: 30px;
    color: #36363c;
    font-family: "Graphik Bold";
    margin-bottom: 20px;
  }

  .dropbtn-b {
    background-color: #787878;
    color: white;
    padding: 10px;
    font-family: "Graphik Regular";
    font-weight: bold;
    font-size: 10px;
    border: none;
    cursor: pointer;
    min-width: 140px;
    text-anchor: middle;
  }

  /* The container <div> - needed to position the dropdown content */
  .dropdown-bar-chart {
    position: relative;
    display: inline-block;
    text-anchor: middle;
    margin-bottom: 10px;
  }

  /* Dropdown Content (Hidden by Default) */
  .dropdown-bar-content {
    display: none;
    position: absolute;
    background-color: #f1f1f1;
    min-width: 140px;
    z-index: 1;
    max-height: 530px;
    overflow: auto;
    text-anchor: middle;
  }

  /* Links inside the dropdown */
  .dropdown-bar-content a {
    color: #404e4d;
    font-size: 10px;
    font-family: "Graphik Regular";
    font-weight: bold;
    padding: 8px 0px;
    text-decoration: none;
    display: block;
    text-anchor: middle;
    text-align: center;
  }

  /* Change color of dropdown links on hover */
  .dropdown-bar-content a:hover {
    background-color: #ddd;
  }

  /* Show the dropdown menu on hover */
  .dropdown-bar-chart:hover .dropdown-bar-content {
    display: block;
  }

  /* Change the background color of the dropdown button when the dropdown content is shown */
  .dropdown-bar-chart:hover .dropbtn-b {
    background-color: #247DC5;
  }

  .svg-bar-container {
      margin: auto;
    width: 900px;
    height: 460px;
  }

  .bar-axis-label {
    text-anchor: middle;
    text-align: center;
    font-size: 12px;
    font-family: "Graphik Regular";
  }

  .map-container {
    grid-column: 2 / span 1;
    grid-row: 1 / span 3;
    position: relative;
  }

  .tick > line {
    stroke: lightgrey;
    stroke-opacity: 1;
    shape-rendering: crispEdges;
  }

  .node-tooltip {
    position: fixed;
    z-index: 99999;
    left: 0;
    top: 0;
    padding: 0.5em 1em;
    background: rgba(255, 255, 255, 1.0);
    pointer-events: none;
    opacity: 0;
    text-align: left;
    text-anchor: start;
    max-width: 400px;
    font-size: 10px;
    box-shadow: 0 4px 12px 0px rgba(0,0,0,.25);
    
  }

  .node-tooltip-title {
    font-family: "Graphik Bold";
    padding-top: 3px;
    padding-bottom: 5px;
  }

  .node-tooltip-funding {
    font-family: "Graphik Regular";
    padding-bottom: 3px;
  }

  .node-tooltip-description {
    font-family: "Graphik Regular";
    padding-bottom: 3px;
  }

  #opp-space-tooltip-container {
    max-width: 200px;
    position: fixed;
    display: none;
  }

  .opp-space-tooltip {
    padding: 0.5em 1em;
    background: rgba(255, 255, 255, 1.0);
    text-align: left;
    text-anchor: start;
    max-width: 400px;
    font-size: 10px;
    box-shadow: 0 4px 12px 0px rgba(0,0,0,.25);
  }

  .opp-space-tooltip-title {
    font-family: "Graphik Bold";
    padding-top: 3px;
    padding-bottom: 5px;
  }

  .opp-space-tooltip-sub-heading {
    font-family: "Graphik Regular";
    padding-bottom: 3px;
  }

  .opp-space-tooltip-item {
    font-family: "Graphik Regular";
    padding-bottom: 5px;
  }



  .bold {
    font-family: "Graphik Bold";
    padding-top: 5px;
  }

    </style>

  </head>

  <body>
      <div id="key-container"></div>
    <div class="node-tooltip">
      <div class="node-tooltip-title"></div>
      <div class="node-tooltip-funding"></div>
      <div class="node-tooltip-description"></div>
    </div>
    <div class="popup-bg">
        <div class="popup-container added">
          <div class="popup-tag">
            <div id="theme-tag" class="popup-tag-item">Theme</div>
            <div class="popup-tag-item-arr"> > </div>
            <div id="focus-area-tag" class="popup-tag-item">Focus Area</div>
          </div>
          <div class="popup-close">
            <i class="fas fa-times"></i>
          </div>
          <div class="popup-section-a">
            <div class="column left">
              <div class="svg-container">
              </div>
                <div class="opportunity-space-title">
                  Primary SDG
                </div>
              <div class="opportunity-space-description">
                New, greener cement formulations that reduce carbon through replacing traditional clinker
              </div>
              <div class="opportunity-space-summary">
                <div class="opportunity-space-summary-row">
                  <div class="opp-space-summary-column column-icon">
                    <i class="fas fa-columns"></i>
                  </div>
                  <div class="opp-space-summary-column column-desc">Total No. Of Startups: </div>
                  <div id="total-no-startups" class="opp-space-summary-column column-value"></div>
                </div>
                <div class="opportunity-space-summary-row">
                  <div class="opp-space-summary-column column-icon">
                    <i class="fas fa-dollar-sign"></i>
                  </div>
                  <div class="opp-space-summary-column column-desc">Total + Average Funding Amount: </div>
                  <div id="total-avg-funding" class="opp-space-summary-column column-value"></div>
                </div>
                <div class="opportunity-space-summary-row">
                  <div class="opp-space-summary-column column-icon">
                    <i class="far fa-calendar-alt"></i>
                  </div>
                  <div class="opp-space-summary-column column-desc">Avg Founded Year + Maturity: </div>
                  <div id="avg-funding-year" class="opp-space-summary-column column-value"></div>
                </div>
              </div>
            </div>
            <div class="column right">
              <div class="right-title">Hero Startups</div>
           <table>
              <tr id="hs-0" class="hero-startup-container">
                <td
                  id="hs-logo-container-0"
                  class="hero-startup-logo-container"
                >
                  <img id="hs-logo-0" class="hero-startup-logo" src="" />
                </td>
                <td id="hs-desc-0" class="hero-startup-desc">
                  <div id="hs-ov-0" class="hero-startup-desc-overview"></div>
                  <div id="hs-prb-0" class="hero-startup-desc-problem"></div>
                  <div id="hs-sln-0" class="hero-startup-desc-solution"></div>
                </td>
                <td class="hero-startup-stats">
                  <div
                    id="hs-website-0"
                    class="hero-startup-stats-website"
                  ></div>
                  <div
                    id="hs-Country-0"
                    class="hero-startup-stats-Country"
                  ></div>
                  <div id="hs-round-0" class="hero-startup-stats-round"></div>
                  <div id="hs-amount-0" class="hero-startup-stats-amount"></div>
                  <div id="hs-year-0" class="hero-startup-stats-year"></div>
                </td>
              </tr>

              <tr id="hs-1" class="hero-startup-container">
                <td
                  id="hs-logo-container-1"
                  class="hero-startup-logo-container"
                >
                  <img id="hs-logo-1" class="hero-startup-logo" src="" />
                </td>
                <td id="hs-desc-1" class="hero-startup-desc">
                  <div id="hs-ov-1" class="hero-startup-desc-overview"></div>
                  <div id="hs-prb-1" class="hero-startup-desc-problem"></div>
                  <div id="hs-sln-1" class="hero-startup-desc-solution"></div>
                </td>
                <td class="hero-startup-stats">
                  <div
                    id="hs-website-1"
                    class="hero-startup-stats-website"
                  ></div>
                  <div
                    id="hs-Country-1"
                    class="hero-startup-stats-Country"
                  ></div>
                  <div id="hs-round-1" class="hero-startup-stats-round"></div>
                  <div id="hs-amount-1" class="hero-startup-stats-amount"></div>
                  <div id="hs-year-1" class="hero-startup-stats-year"></div>
                </td>
              </tr>

              <tr id="hs-2" class="hero-startup-container">
                <td
                  id="hs-logo-container-2"
                  class="hero-startup-logo-container"
                >
                  <img id="hs-logo-2" class="hero-startup-logo" src="" />
                </td>
                <td id="hs-desc-2" class="hero-startup-desc">
                  <div id="hs-ov-2" class="hero-startup-desc-overview"></div>
                  <div id="hs-prb-2" class="hero-startup-desc-problem"></div>
                  <div id="hs-sln-2" class="hero-startup-desc-solution"></div>
                </td>
                <td class="hero-startup-stats">
                  <div
                    id="hs-website-2"
                    class="hero-startup-stats-website"
                  ></div>
                  <div
                    id="hs-Country-2"
                    class="hero-startup-stats-Country"
                  ></div>
                  <div id="hs-round-2" class="hero-startup-stats-round"></div>
                  <div id="hs-amount-2" class="hero-startup-stats-amount"></div>
                  <div id="hs-year-2" class="hero-startup-stats-year"></div>
                </td>
              </tr>
            </table>
            </div>
          </div>
          <div class="popup-section-b">
              <div class="bar-chart-title">Bar Chart</div>
              <div class="dropdown-bar-chart">
                  <button class="dropbtn-b">
                    <i class="arrow down"> </i> Select Data
                  </button>
                  <div class="dropdown-bar-content" id="bar-chart-selector"></div>
                </div>
                <div class="svg-bar-container"></div>
          </div>
          <div class='analysis-btn'>
            <i class="fas fa-chevron-circle-down"></i>
            <div class="popup-analysis-label">Analysis</div>
          </div>
  
        </div>
      </div>
    <div class="left-sidebar">
      <div class="left-sidebar-header">
        <img src="assets/logo.png">
      </div>

      <div class="left-sidebar-buttons">
        <div id="radar-toggle-btn" class="left-sidebar-btn">
        <div class="left-sidebar-btn-label">Radar</div>
        <i class="fas fa-bullseye fa-lg"></i>
        
        </div>
        <div id="map-toggle-btn" class="left-sidebar-btn">
        <div class="left-sidebar-btn-label">Map</div>
        <i class="far fa-map fa-lg"></i>
        
        </div>
      </div>
    </div>

    <div id="hover-info-container"></div>
  <div id="opp-space-tooltip-container">
      <div class="opp-space-tooltip">
      <div class="opp-space-tooltip-title"></div>
      <div id="ostt-1" class="opp-space-tooltip-item"></div>
      <div id="ostt-2" class="opp-space-tooltip-sub-heading">Total Funding:</div>
      <div id="ostt-3" class="opp-space-tooltip-item"></div>
      <div id="ostt-4" class="opp-space-tooltip-sub-heading">Total Number of Startups:</div>
      <div id="ostt-5" class="opp-space-tooltip-item"></div>
      <div id="ostt-6" class="opp-space-tooltip-sub-heading">Average Funding:</div>
      <div id="ostt-7" class="opp-space-tooltip-item"></div>
      <div id="ostt-8" class="opp-space-tooltip-item bold"></div>
      <div id="ostt-9" class="opp-space-tooltip-item"></div>
    </div>
  </div>
    <div class="map-container">
      <div class="sidebar">
        <div class="sidebar-title"></div>
        <div id="startup-list"></div>
      </div>
  <div class="map-tooltip"></div>
  <div class="bg"></div>
  <div id="map"></div>

</div>
    <div id="chart-container"></div>
    <div id="control-container">
      <div>
          <div>
            <div class="button b2" id="button-16">
              <input type="checkbox" class="checkbox" />
              <div class="knobs"></div>
              <div class="layer"></div>
            </div>
            <div class="button b2" id="button-17">
              <input type="checkbox" class="checkbox" />
              <div class="knobs"></div>
              <div class="layer"></div>
            </div>
    
            <div>


          <div class="dropdown-client">
            <button class="dropbtn">
                Select Client Served  <i class="arrow down"></i>
              </button>
              <div class="dropdown-content" id="client-selector"></div>
          </div>
          <div id="save-button-container">
            <button class="switch-button" id="save-button">Save Image</button>
          </div>
        </div>
        
      </div>
      
    </div>

    <div id="tmp-container"></div>



    <script>
        var width = 800,
          height = 860,
          innerRadius = 50,
          outerRadius = 300,
          nodeRadius = 3.2,
          nodeOtherWidth = 5.5,
          keySize = 10,
          keySpacing = 10,
          radial = "year",
          animationDuration = 2000,
          keyWidth = 160,
          keyHeight = 260,
          filter = 0,
          filterKey = "",
          clientFilter = "All Startups",
          geoFilter = "All Startups",
          filters = {type: "All Startups", geotype: "All Startups"}
          logoPath = "",
          titleLogoWidth = 80,
          titleLogoHeight = 50,
          hoverOn = 0;
        hoverSegment = "",
        leftWidth = 1100,
          leftHeight = 650,
          bar_width = 900,
          bar_height = 460,
          popupMode = {"page": "none", "type": "none"},
          indexTracker = {},
          indexTrackerYear = {};

      // mapbox access token
      const accessToken =
        "pk.eyJ1Ijoid2F5ZGVoZXJtYW4iLCJhIjoiY2s5ZGtvMXpoMDRjajNscWcwMm9pZnR5ayJ9.ZwyeZ2ykn8jZac12i4FEqA";

      L.mapbox.accessToken = accessToken;

    var categoryFontObject = [
      { name: 'themeFont',
        dy_upper: "-1.15em",
        dy_lower: "1.85em"
      },
      {
        fontSize: "30px",
        letterSpacing: "5px",
        letterSpaceVal: 5,
        dy_upper: "-1.05em",
        dy_lower: "1.8em"
      },
      {
        fontSize: "24px",
        letterSpacing: "4px",
        letterSpaceVal: 4,
        dy_upper: "-1.25em",
        dy_lower: "2em"
      }
    ];

            // loader settings
          var opts = {
            lines: 9, // The number of lines to draw
            length: 7, // The length of each line
            width: 8, // The line thickness
            radius: 24, // The radius of the inner circle
            top: "57%",
            left: "38.5%",
            color: "#132A54", // #rgb or #rrggbb or array of colors
            speed: 1.9, // Rounds per second
            trail: 40, // Afterglow percentage
            className: "spinner" // The CSS class to assign to the spinner
          };

          var target = document.getElementById("chart-container");

          var spinner = new Spinner(opts).spin(target);

          d3.select("#radar-toggle-btn").attr("class", "left-sidebar-btn active")
          d3.select(".popup-bg").style("display", "none")

          function responsivefy(svg) {
          // get container + svg aspect ratio
          var container = d3.select(svg.node().parentNode),
            width = parseInt(svg.style("width")),
            height = parseInt(svg.style("height")),
            aspect = width / height;

          // add viewBox and preserveAspectRatio properties,
          // and call resize so that svg resizes on inital page load
          svg
            .attr("viewBox", "0 0 " + width + " " + height)
            .attr("perserveAspectRatio", "xMinYMid")
            .call(resize);

          // to register multiple listeners for same event type,
          // you need to add namespace, i.e., 'click.foo'
          // necessary if you call invoke this function for multiple svgs
          // api docs: https://github.com/mbostock/d3/wiki/Selections#on
          d3.select(window).on("resize." + container.attr("id"), resize);

          // get width of container and resize svg to fit it
          function resize() {
            targetWidth = window.innerWidth - 360
            targetHeightFromWidth = Math.round(targetWidth / aspect)
            targetHeight = window.innerHeight
            if (targetHeightFromWidth > targetHeight) {
              svg.attr("width", Math.round(targetHeight*aspect));
              svg.attr("height", targetHeight);
            } else {
              svg.attr("width", targetWidth);
              svg.attr("height", targetHeightFromWidth);
            }

          }
        }
  
        var svg = d3
          .select("#chart-container")
          .append("svg")
          .attr("width", width)
          .attr("height", height)
          .call(responsivefy)

          const svg_width = d3.select("#chart-container").node().clientWidth

          

          d3.select("#chart-container").style("left", (146 + (window.innerWidth - (180+200)-svg_width)/2) + "px")
          const svg_left = (d3.select("#chart-container").style("left"))
          d3.select("#key-container").style("left", (+svg_left.slice(0,-2) + svg_width) + "px").style("top", (window.innerHeight/2 - 60) + "px")
          d3.select("#control-container").style("left", (+svg_left.slice(0,-2) + svg_width) + "px").style("top", (window.innerHeight/2 + 80) + "px")
          d3.select("#opp-space-tooltip-container").style("left", (+svg_left.slice(0,-2) + svg_width+160) + "px").style("top", (window.innerHeight/2-60) + "px")
  
        var chartSVG = svg
          .append("g")
          .attr(
            "transform",
            "translate(" + width / 2 + "," + (height / 2 + 20) + ")"
          );
  
        var keySVG = d3
          .select("#key-container")
          .append("svg")
          .attr("width", keyWidth)
          .attr("height", keyHeight)
          .append("g")
          .attr(
            "transform",
            "translate(" + keyWidth / 2 + "," + keyHeight / 2 + ")"
          );
  
        var chartTitle = chartSVG
          .append("text")
          .attr("class", "chart-title")
          .text("SDG Compass")
          .attr("y", (-height * 4.55) / 10)
          .style("display", "none")
  
        d3.select(".map-container").style("display", "none")
        d3.select(".map-tooltip").style("display", "none")

        /*var chartLogo = chartSVG
          .append("image")
          .attr("xlink:href", logoPath)
          .attr("width", titleLogoWidth)
          .attr("height", titleLogoHeight)
          .attr("y", -titleLogoHeight / 2)
          .attr("x", -titleLogoWidth / 2)
          .style("display", "none")*/
  
        d3.csv(
          "https://docs.google.com/spreadsheets/d/e/2PACX-1vQwCsO-wadJhd2NnBHjzdEV-sHNGlNsbaiWujn_lQ3blZpUTryeAlksFPrDNBbPZAxZHBNV2yraawVY/pub?gid=0&single=true&output=csv"
        ).then(function(data) {
          /*d3.csv(
          "https://docs.google.com/spreadsheets/d/e/2PACX-1vSafGm_gSEK_M6dTEcS3sd2N7CcehHPfg561BJtgzrHClIt5DH79yqHI1LpeOLbbwGob_Xi0kVUdxMB/pub?gid=1462501778&single=true&output=csv"
          ).then(function(desc) {*/

          var transform = d3.geoTransform({ point: projectPoint }),
            path = d3.geoPath().projection(transform);
            
            d3.select("#map").attr("width", (window.innerWidth) + "px").attr("height", (window.innerHeight) + "px")
              .style("width", (window.innerWidth) + "px")

          var map = new L.Map("map", {
            center: [0, 100],
            zoom: 2,
            minZoom: 2,
            maxZoom: 6,
            }).whenReady(function() {
              setTimeout(function(){ 
                map.invalidateSize(true)}, 400);
              //L.Map.invalidateSize()
            }).addLayer(
              new L.TileLayer(
                "https://api.mapbox.com/styles/v1/mapbox/light-v10/tiles/{z}/{x}/{y}?access_token=" +
                  accessToken,
                {
                  attribution:
                    '© <a href="https://apps.mapbox.com/feedback/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                }
              )
            );



              spinner.stop();
              d3.select("#button-16").style("display", "block")
              //d3.select("#button-17").style("display", "block")
              //d3.select(".dropdown-client").style("display", "inline-block")
              d3.select("#save-button").style("display", "block")
              d3.select(".chart-title").style("display", "")
              //chartLogo.style("display", "block")

              d3.json("assets/world_countries.json").then(function(json) {

                //d3.csv("assets/worldcities.csv").then(function(cityData) {

              var focusAreaOrder = [
              "SDG 1: No Poverty",
              "SDG 2: Zero Hunger",
              "SDG 3: Good Health and Well-being",
              "SDG 4: Quality Education",
              "SDG 5: Gender Equality",
              "SDG 6: Clean Water and Sanitation",
              "SDG 7: Affordable and Clean Energy",
              "SDG 8: Decent Work and Economic Growth",
              "SDG 9: Industry Innovation and Infrastructure",
              "SDG 10: Reduced Inequalities",
              "SDG 11: Sustainable Cities and Communities",
              "SDG 12: Responsible Consumption and Production",
              "SDG 13: Climate Action",
              "SDG 14: Life Below Water",
              "SDG 15: Life on Land",
              "SDG 16: Peace Justice and Strong Institutions",
              "SDG 17: Partnerships for the Goals"
              ]

              var colorList = [
              "#E5233D",
              "#DDA73B",
              "#4CA247",
              "#C7202F",
              "#EF402D",
              "#29BFE6",
              "#FBC414",
              "#A31C44",
              "#F26A2E",
              "#E01583",
              "#F89D29",
              "#BF8D2C",
              "#407F46",
              "#1F97D4",
              "#5ABA47",
              "#136A9F",
              "#13496B"
              ]

              var colorScale = d3.scaleOrdinal()
                .domain(focusAreaOrder)
                .range(colorList)
                console.log('data', data)

              data = data.filter(function(d) {
                return d["Complete"] === "TRUE"
              })
              

              /*var focusAreaOrder = desc.map(function(d) {
                return d["Primary SDG"].toLowerCase()
              });

              var themeOrder = [... new Set(desc.map(function(d) {
                return d["Theme"]
              }))]*/

              // Filter data for startups noot in description:
             /* new_data = []
              data.forEach(function(d) {
                d["Primary SDG"] = d["Primary SDG"].toLowerCase()
                if (d["Primary SDG"] === "") {
                  console.log('ERROR, blank Primary SDG Entry:', d)
                }
                if (d["YearFounded"] === "") {
                  console.log('ERROR, blank Founded Entry:', d)
                }
                if (d["Maturity"] === "") {
                  console.log('ERROR, blank Maturity Entry:', d)
                }
                if (focusAreaOrder.indexOf(d["Primary SDG"]) < 0) {
                  console.log('ERROR, bad Primary SDG Entry:', d)
                } else {
                  new_data.push(d)
                }
              })*/

            data = data.filter(function(d) {
              return d["Primary SDG"] !== "" && d["Primary SDG"] !== "x";
            });
  
            data = data.filter(function(d) {
              return d["Founded"] !== "";
            });

            data = data.filter(function(d) {
              return +d["Founded"] > 2004;
            });
            /*
             data = data.filter(function(d) {
              return d["Maturity"] !== "";
            });*/

            /*data_city = d3
            .nest()
            .key(function(d) {
              return d.City;
            })
            .entries(data);

            var q = d3.queue();
            var geocoder = L.mapbox.geocoder("mapbox.places");


            data_city.forEach(function(v) {
              cityData.forEach(function(w) {
                if (v.key == w.city && v.values[0].Country == w.country) {
                  v.cityLat = +w.lat
                  v.cityLng = +w.lng
                }
              })
              if (v.cityLat == null) {
                  q.defer(getCountry2, v);
              }
            })

            function getCountry2(data, callback) {
                console.log(data.key + ", " + data.values[0].Country)

                  geocoder.query(data.key + ", " + data.values[0].Country, function (error, point) {
                    data.cityLat = point.latlng[0]
                    data.cityLng = point.latlng[1]
                  });

              callback(null);
            }*/
            
              json.features.push({"type": "features", "properties": {"name": "Singapore"}, "geometry": {"type": "Polygon", "coordinates": [[0, 0]]}})
              json.features.push({"type": "features", "properties": {"name": "Bahrain"}, "geometry": {"type": "Polygon", "coordinates": [[0, 0]]}})
  
              d3.select("#radar-toggle-btn").on("click", function() {
                d3.select("#map-toggle-btn").attr("class", "left-sidebar-btn")
                d3.select("#radar-toggle-btn").attr("class", "left-sidebar-btn active")
                d3.select("body").style("background-color", "white")
                toggle_map("off");
              });

              function modeArray(array) {
                if (array.length == 0) return null;
                var modeMap = {},
                  maxCount = 1,
                  modes = [];
              
                for (var i = 0; i < array.length; i++) {
                  var el = array[i];
              
                  if (modeMap[el] == null) modeMap[el] = 1;
                  else modeMap[el]++;
              
                  if (modeMap[el] > maxCount) {
                    modes = [el];
                    maxCount = modeMap[el];
                  } else if (modeMap[el] == maxCount) {
                    modes.push(el);
                    maxCount = modeMap[el];
                  }
                }
                return modes;
              }

              function city_hover(d, i) {
                d3.selectAll(".city-circle").attr("fill", function(v) {
                  if (d.key == v.key) {
                    return "#247DC5"
                  } else {
                    return "#7DCCFF"
                  }
                }).attr("stroke", function(v) {
                  if (d.key == v.key) {
                    return "#247DC5"
                  } else {
                    return "#7DCCFF"
                  }
                })

                var tooltip = "<div>" + d.key + "<\/div>";
                tooltip += "<div>Startups: " + d.values.length + "<\/div>";
                d3.select(".map-tooltip")
                  .html(tooltip)
                  .style("top", function() {
                    return d3.event.y + "px";
                  })
                  .style("left", function() {
                    return (d3.event.x-136) + "px";
                  })
                  .style("display", "");
                
                d3.select(".sidebar-title").html(d.key);

                startup_list = [];
                d.values.forEach(function(w) {
                    var obj = {
                      "Startup": w["Startup Name"],
                      Funding: w["Funding amount ($)"],
                      Website: w["Website"],
                      "Founded": w["Founded"]
                    };
                    startup_list.push(obj);
                });
                var table = "";
                table += "<table class='startup-table'>";
                  table +=
                    "<tr class='table-header'><td>Company:<\/td><td>Funding:<\/td><td>Founded Year:<\/td><\/tr>"
                startup_list.forEach(function(v) {
                  table +=
                    "<tr><td><a href='" + v.Website + "' target='_blank'>" +
                    v["Startup"] +
                    "</a><\/td><td>$" +
                      formatFunding(v.Funding) +
                    "<\/td><td>" +
                    v["Founded"] +
                    "<\/td><\/tr>";
                });
                table += "<\/table>";
                d3.select("#startup-list").html(table);

              }


  
              function country_hover(d, i) {

                d3.selectAll(".country-circle")
                  .attr("fill", function(v) {
                    if (v.properties.name === d.properties.name) {
                      return "#247DC5"
                    } else {
                      return "#7DCCFF"
                    }
                    
                  })
                  .attr("stroke", function(v) {
                    if (v.properties.name === d.properties.name) {
                      return "#247DC5"
                    } else {
                      return "#7DCCFF"
                    }
                  });
 
                var tooltip = "<div>" + d.properties.name + "<\/div>";
                tooltip += "<div>Startups: " + d.properties.startups + "<\/div>";
                d3.select(".map-tooltip")
                  .html(tooltip)
                  .style("top", function() {
                    return d3.event.y + "px";
                  })
                  .style("left", function() {
                    return (d3.event.x-136) + "px";
                  })
                  .style("display", "");
  
                d3.select(".sidebar-title").html(d.properties.name);
  
                startup_list = [];
                data.forEach(function(w) {
                  if (w.Country === d.properties.name) {
                    var obj = {
                      "Startup": w["Startup Name"],
                      Funding: w["Funding amount ($)"],
                      Website: w["Website"],
                      "Founded": w["Founded"]
                    };
                    startup_list.push(obj);
                  }
                });
                var table = "";
                table += "<table class='startup-table'>";
                  table +=
                    "<tr class='table-header'><td>Company:<\/td><td>Funding:<\/td><td>Founded Year:<\/td><\/tr>"
                startup_list.forEach(function(v) {
                  table +=
                    "<tr><td><a href='" + v.Website + "' target='_blank'>" +
                    v["Startup"] +
                    "</a><\/td><td>$" +
                      formatFunding(v.Funding) +
                    "<\/td><td>" +
                    v["Founded"] +
                    "<\/td><\/tr>";
                });
                table += "<\/table>";
                d3.select("#startup-list").html(table);
              }

              function update_popup(d) {
                popupMode.page = "section-a"
                popupMode.type = "radar"
                d3.select(".popup-container").attr("class", "popup-container added")
                d3.select(".popup-bg").style("display", "")
                d3.select(".popup-section-a").style("display", "")
                d3.select(".popup-section-b").style("display", "none")
                d3.select(".analysis-btn").style("display", "")
                d3.select(".popup-analysis-label").html("Analysis")
                
                var opp_space = d.data.value.key
                var funding_amount = d.data.value.value

                d3.select(".svg-container").html("")

                chartPieData.forEach(function(v, i) {
                    if (v.data.value.key === opp_space) {
                        
                        var selection =
                        "#background-segment-" +
                        v.data.value.key
                          .replace(/ /g, "-")
                          .replace(/&/g, "and");
                          var tmp_width =
                          d3
                            .select(selection)
                            .node()
                            .getBoundingClientRect().width + 40
                        var tmp_height =
                          d3
                            .select(selection)
                            .node()
                            .getBoundingClientRect().height + 40

                        d3.select(".svg-container").style("width", tmp_width + "px").style("height", tmp_height + "px")
        
                        var tmp_svg = d3
                          .select(".svg-container")
                          .append("svg")
                          .attr("width", tmp_width)
                          .attr("height", tmp_height);

                          if (i === 0) {
                            var hor = tmp_width - 170
                            var ver = tmp_height + 45;
                          }
                          if (i === 1) {
                            var hor = tmp_width - 290;
                            var ver = tmp_height + 20;
                          }
                          if (i === 2) {
                            var hor = tmp_width - 340;
                            var ver = tmp_height - 20;
                          }
                          if (i === 3) {
                            var hor = tmp_width - 335;
                            var ver = tmp_height - 170;
                          }
                          if (i === 4) {
                            var hor = tmp_width - 290;
                            var ver = tmp_height - 290;
                          }
                          if (i === 5) {
                            var hor = tmp_width - 180;
                            var ver = tmp_height - 330;
                          }
                          if (i === 6) {
                            var hor = tmp_width - 15;
                            var ver = tmp_height - 330;
                          }
                          if (i === 7) {
                            var hor = tmp_width + 20;
                            var ver = tmp_height - 290;
                          }
                          if (i === 8) {
                            var hor = tmp_width + 40;
                            var ver = tmp_height - 180;
                          }
                          if (i === 9) {
                         var hor = tmp_width + 40;
                            var ver = tmp_height - 10;
                          }
                          if (i === 10) {
                            var hor = tmp_width + 25;
                            var ver = tmp_height + 25;
                          }
                          if (i === 11) {
                            var hor = tmp_width - 15;
                            var ver = tmp_height + 45;
                          }

                          var tmp_chartSVG = tmp_svg
                          .append("g")
                          .attr("transform", "translate(" + hor + "," + ver + ")");

                          if (radial === "maturity") {
                            
                            var tmp_nascentSegments = tmp_chartSVG
                              .selectAll("nascent-segments")
                              .data([v])
                              .enter()
                              .append("path")
                              .style("fill-opacity", 1)
                              .attr("class", function(d) {
     
                                return (
                                  "nascent-segments segment-" +
                                  d.data.value.key.replace(/ /g, "-").replace(/&/g, "and")
                                );
                              })
                              .attr("id", function(d) {
                                return (
                                  "tmp-nascent-segment-" +
                                  d.data.value.key.replace(/ /g, "-").replace(/&/g, "and")
                                );
                              })
                              .style("stroke", "white")
                              .style("stroke-width", "2px")
                              .attr("fill", "#DFDFDF") //F4F4F4
                              .attr("d", nascentArc);
          
                            var tmp_emergingSegments = tmp_chartSVG
                              .selectAll("emerging-segments")
                              .data([v])
                              .enter()
                              .append("path")
                              .style("fill-opacity", 1)
                              .attr("class", function(d) {
                                return (
                                  "emerging-segments segment-" +
                                  d.data.value.key.replace(/ /g, "-").replace(/&/g, "and")
                                );
                              })
                              .attr("id", function(d) {
                                return (
                                  "tmp-emerging-segment-" +
                                  d.data.value.key.replace(/ /g, "-").replace(/&/g, "and")
                                );
                              })
                              .style("stroke", "white")
                              .style("stroke-width", "2px")
                              .attr("fill", "#E9E9E9")
                              .attr("d", emergingArc);
          
                            var tmp_matureSegments = tmp_chartSVG
                              .selectAll("mature-segments")
                              .data([v])
                              .enter()
                              .append("path")
                              .style("fill-opacity", 1)
                              .attr("class", function(d) {
                                return (
                                  "mature-segments segment-" +
                                  d.data.value.key.replace(/ /g, "-").replace(/&/g, "and")
                                );
                              })
                              .attr("id", function(d) {
                                return (
                                  "tmp-mature-segment-" +
                                  d.data.value.key.replace(/ /g, "-").replace(/&/g, "and")
                                );
                              })
                              .style("stroke", "white")
                              .style("stroke-width", "2px")
                              .attr("fill", "#F4F4F4") //DFDFDF
                              .attr("d", matureArc);
                          } else {  
                            count_by_year.forEach(function(w) {
                              var tmpArc = d3
                                .arc()
                                .innerRadius(w.inner)
                                .outerRadius(w.outer);
          
                              var tmpSegment = tmp_chartSVG
                                .selectAll("year-segment")
                                .data([v])
                                .enter()
                                .append("path")
                                .attr("class", "segment")
                                .attr("d", tmpArc)
                                .attr("fill", "#f4f4f4");
                            });
                          }

                    var tmpSegmentsLabelBand = tmp_chartSVG
              .selectAll("path.segment-band")
              .data([chartPieData[i]])
              .enter()
              .append("path")
              .classed("segment-band", true)
              .attr("d", segmentLabelBandArc)
              .attr("fill", "#7DCCFF")
              .each(function(d, i) {
                var firstArcSection = /(^.+?)L/;
                var newArc = firstArcSection.exec(d3.select(this).attr("d"))[1];
                d.newArc = newArc.replace(/,/g, " ");
                d.percentage =
                  ((d.endAngle - d.startAngle) / 2 + d.startAngle) / 0.0628319;
                if (d.percentage >= 100) {
                  d.percentage -= 100;
                }
                if (d.percentage >= 25 && d.percentage <= 75) {
                  var startLoc = /M(.*?)A/;
                  var middleLoc = /A(.*?)0 0 1/;
                  var endLoc = /0 0 1 (.*?)$/;
                  d.newStart = endLoc.exec(d.newArc)[1];
                  d.newEnd = startLoc.exec(d.newArc)[1];
                  d.middleSec = middleLoc.exec(d.newArc)[1];
                  d.newArc =
                    "M" + d.newStart + "A" + d.middleSec + "0 0 0 " + d.newEnd;
                }
                d.hiddenArc = tmp_chartSVG
                  .append("path")
                  .attr("class", "hiddenDonutArcs")
                  .attr("id", function() {
                    return (
                      "hidden-opp-space-tmp-band-" + d.data.value.key.replace(/_/g," ")
                    );
                  })
                  .attr("d", d.newArc)
                  .style("fill", "none");
              })

              var tmpOppSpaceLabels = tmp_chartSVG
                .selectAll(".opp-space-label-text")
                .data([chartPieData[i]])
                .enter()
                .append("g")
                .selectAll(".test-class")
                .data(function(d) {
                  var limit = labelFontData.limit;

                  return textWrap(
                    d.data.value.key.toUpperCase().replace(/_/g," "),
                    d.percentage,
                    limit
                  );
                })
                .enter()
                .append("text")
                .attr("class", "label opp-space-label-text")
                .attr("dy", function(d, i) {
                  if (d.percentage >= 25 && d.percentage <= 75) {
                    if (d.lineLength === 1) {
                      return "-1.1em";
                    } else {
                      if (i === 0) {
                        return "-1.6em";
                      } else {
                        return "-0.6em";
                      }
                    }
                  } else {
                    if (d.lineLength === 1) {
                      return "1.8em";
                    } else {
                      if (i === 0) {
                        return "1.3em";
                      } else {
                        return "2.3em";
                      }
                    }
                  }
                })
                .append("textPath")
                .attr("xlink:href", function(d, i) {
                  return (
                    "#" +
                    "hidden-opp-space-tmp-band-" +
                    d.text_data.toLowerCase()
                  );
                })
                .attr("startOffset", "50%")
                .text(function(d) {
                  return d.data
                });


  

                          var tmp_nodes = tmp_chartSVG
                          .selectAll("nodes")
                          .data(data)
                          .enter()
                          .append("circle")
                          .attr("class", "nodes")
                          .attr("r", function(d) {
                            if (d["Funding Round"] !== "Acquired") {
                              return nodeRadius;
                            }
                          })
                          .attr("opacity", function(d) {
                            return d.opacity;
                          })
                          .attr("fill", function(d) {
                            return nodeColorScale(
                              fundingCategoryScale(d["Funding Round"])
                            );
                          })
                          .attr("cx", function(d) {
                            if (radial === "maturity") {
                              return d.x;
                            } else {
                              return d.yearX;
                            }
                          })
                          .attr("cy", function(d) {
                            if (radial === "maturity") {
                              return d.y;
                            } else {
                              return d.yearY;
                            }
                          })
                          .attr("opacity", function(d) {
                            if (
                              d["Primary SDG"] === chartPieData[i].data.value.key
                            ) {
                              return d.opacity;
                            } else {
                              return 0;
                            }
                          })
                          .style("cursor", "pointer")
                           .on("mouseover", function(d) {
                              showNodeTooltip(d)
                            })
                            .on("mouseout", hideNodeTooltip);

                          var tmp_acquired = tmp_chartSVG
                          .selectAll("nodes-acquired")
                          .data(data)
                          .enter()
                          .append("rect")
                          .attr("class", "nodes nodes-acquired")
                          .attr("opacity", function(d) {
                            return d.opacity;
                          })
                          .attr("opacity", function(d) {
                            return d.opacity;
                          })
                          .attr("width", function(d) {
                            if (d["Funding Round"] === "Acquired") {
                              return nodeOtherWidth
                            } else {
                              return 0;
                            }
                          })
                          .attr("height", function(d) {
                            if (d["Funding Round"] === "Acquired") {
                              return nodeOtherWidth
                            } else {
                              return 0;
                            }
                          })
                          .attr("x", 0)
                          .attr("y", 0)
                          .attr("fill", "#FFFD82")
                          .attr("transform", function(d) {
                            if (radial === "maturity") {
                              var x = d.x;
                              var y = d.y;
                            } else {
                              var x = d.yearX;
                              var y = d.yearY;
                            }
                            return "translate(" + x + "," + y + ")    rotate(45)";
                          })
                          .attr("opacity", function(d) {
                            if (
                              d["Primary SDG"] === chartPieData[i].data.value.key
                            ) {
                              return d.opacity;
                            } else {
                              return 0;
                            }
                          });
      



                    }
                })

                var popup_data = data.filter(function(d) {
                    return d["Primary SDG"].toLowerCase() === opp_space;
                  });

                  var numStartups = popup_data.length

                  var avgFunding = funding_amount/numStartups

                  yearTotal = 0
                  maturityList = []
                  popup_data.forEach(function(v) {
                    yearTotal += +v["Founded"]
                    if (v.Maturity !== "") {
                      maturityList.push(v.Maturity)
                    }
                  })

                  var avgYear = Math.round(yearTotal/numStartups)
                  var maturityMode = modeArray(maturityList)

                  d3.select("#theme-tag").html(popup_data[0]["Theme"])
                  d3.select("#focus-area-tag").html(popup_data[0]["Primary SDG"])
                  d3.select(".opportunity-space-title").html(popup_data[0]["Primary SDG"])
                  d3.select(".opportunity-space-description").html(popup_data[0]["Primary SDG Description"])
                  d3.select("#total-no-startups").html(numStartups)
                  d3.select("#total-avg-funding").html("$" + formatFunding(funding_amount) + ", $" + formatFunding(avgFunding))
                  d3.select("#avg-funding-year").html(avgYear + ", " + maturityMode[0] )
                  d3.select("#most-active-competitor").html(popup_data[0]["Most Active Competitor"])
                  d3.select("#most-pop-tech").html(popup_data[0]["Popular Technology + Business Model"])
                  d3.select("#pattern-recognized").html(popup_data[0]["Pattern Recognised"])
                  

                  heroPopupData = []
                  hero_data.forEach(function(v) {
  
                      if (v["Primary SDG"].toLowerCase() === opp_space) {
                        heroPopupData.push(v)
                      }
                  })

                  var extra = [0, 1, 2]
                  heroPopupData.forEach(function(v, i) {
                    extra = extra.splice(1)
                      if (v["Startup"] !== "COMPETITOR") {
                        d3.select("#hs-" + i).style("display", "")

                          if (v["Logo URL"] !== "") {
                              var logo_url = v["Logo URL"]
                          } else {
                              var logo_url = "assets/default_logo.png"
                          }
                          var hs_ov = "<span style='font-family: Graphik Bold'>Overview:<\/span> "
                            hs_ov += v["Overview"]
                            var hs_prb = "<span style='font-family: Graphik Bold'>Problem:<\/span> "
                                hs_prb += v["Problem"]
                                var hs_sln = "<span style='font-family: Graphik Bold'>Solution:<\/span> "
                                    hs_sln += v["Solution "]

                                    var hs_website = "<span style='font-family: Graphik Bold'>Website:<\/span> "
                                        hs_website += "<a href='" + v["Website"] + "' target='_blank'>" + v["Website"] + "<\/a>"

                                    var hs_Country = "<span style='font-family: Graphik Bold'>Country:<\/span> "
                                        hs_Country += v["Country"]

                                        var hs_round = "<span style='font-family: Graphik Bold'>Funding Round:<\/span> "
                                            hs_round += v["Funding Round"]
    
                                        var hs_amount = "<span style='font-family: Graphik Bold'>Funding Amount:<\/span> "
                                            hs_amount += v["Funding amount ($)"]
        
                                            var hs_year = "<span style='font-family: Graphik Bold'>Year:<\/span> "
                                                hs_year += v["Founded"]
                            

                        d3.select("#hs-logo-" + i).attr("src", logo_url)
                        d3.select("#hs-ov-" + i).html(hs_ov)
                        d3.select("#hs-prb-" + i).html(hs_prb)
                        d3.select("#hs-sln-" + i).html(hs_sln)
                        hs_c_height = d3.select("#hs-desc-" + i).node()
                        .getBoundingClientRect().height

                        d3.select("#hs-logo-container-" + i).style("height", hs_c_height + "px")

                        d3.select("#hs-website-" + i).html(hs_website)
                        d3.select("#hs-Country-" + i).html(hs_Country)
                        d3.select("#hs-round-" + i).html(hs_round)
                        d3.select("#hs-amount-" + i).html(hs_amount)
                        d3.select("#hs-year-" + i).html(hs_year)
                      } else {
                          d3.select("#hs-" + i).style("display", "none")
                      }
                  })
                  extra.forEach(function(v) {
                    d3.select("#hs-" + v).style("display", "none")
                  })


                  d3.select(".analysis-btn").on("click", function() {
                    d3.select(".popup-container").attr("class", "popup-container added")
                    d3.select(".popup-bg").style("display", "")
                    if (popupMode.page === "section-a") {
                      popupMode.page = "section-b"
                      d3.select(".popup-section-a").style("display", "none")
                      d3.select(".popup-section-b").style("display", "")
                      d3.select(".analysis-btn").style("display", "")
                      d3.select(".popup-analysis-label").html("Insight")
                      bar_data = popup_data
                      bar_data.forEach(function(v) {
                          v.Funding = v["Funding amount ($)"]
                          v["Founded"] = v["Founded"]
                      })
                      update_bar("Amount of Funding")
                    } else {
                      if (popupMode.page === "section-b" && popupMode.type === "radar") {
                        popupMode.page = "section-a"
                        d3.select(".popup-section-a").style("display", "")
                        d3.select(".popup-section-b").style("display", "none")
                        d3.select(".analysis-btn").style("display", "")
                        d3.select(".popup-analysis-label").html("Analysis")
                    
  
                      }
                    }



                  })
              }

              function city_click(d) {
                d3.select(".popup-container").attr("class", "popup-container added")
                d3.select(".popup-bg").style("display", "")
                d3.select(".popup-section-a").style("display", "none")
                d3.select(".popup-section-b").style("display", "")
                d3.select(".analysis-btn").style("display", "none")
                d3.select(".map-tooltip").style("display", "none")


                bar_data = [];
                d.values.forEach(function(w) {
    
                        var obj = {
                            "Startup": w["Startup Name"],
                            Funding: w["Funding amount ($)"],
                            Website: w["Website"],
                            'Founded': w["Founded"],
                            'Maturity': w["Maturity"]
                          };
                          bar_data.push(obj);
    
                })
                update_bar("Amount of Funding")
              }

              function country_click(d) {
                d3.select(".popup-container").attr("class", "popup-container added")
                d3.select(".popup-bg").style("display", "")
                d3.select(".popup-section-a").style("display", "none")
                d3.select(".popup-section-b").style("display", "")
                d3.select(".analysis-btn").style("display", "none")
                d3.select(".map-tooltip").style("display", "none")

                bar_data = [];
                data.forEach(function(w) {
                    if (w.Country === d.properties.name) {
                        var obj = {
                            "Startup": w["Startup Name"],
                            Funding: w["Funding amount ($)"],
                            Website: w["Website"],
                            'Founded': w["Founded"],
                            'Maturity': w["Maturity"]
                          };
                          bar_data.push(obj);
                    }
                })
                update_bar("Amount of Funding")

              }

          /* Initialize the SVG layer */
              var svgLayer = L.svg();
              svgLayer.addTo(map);

  
              var mapSvg = d3.select("#map").select("svg").style("pointer-events", "auto")
              var mapG = d3.select("#map").select("svg").append("g");
              mapG.attr("class", "leaflet-zoom-hide");
  
  
              data_country = d3
                .nest()
                .key(function(d) {
                  return d.Country;
                })
                .entries(data);
  
              json_country = d3
                .nest()
                .key(function(d) {
                  return d.properties.name;
                })
                .entries(json.features);

              data.forEach(function(v) {
                json.features.forEach(function(w) {
                  if (v["Country"] === w.properties.name) {
                    v.json_country = w.properties.name;
                  }
                });
              });
  
              /*var countries = leftG
                .selectAll(".country")
                .data(json.features)
                .enter()
                .append("path")
                .attr("d", leftPath)
                .attr("class", "country")
                .attr("id", function(d) {
                  return "country_" + d.properties.name.replace(/ /g, "-");
                })
                .attr("fill", "#EFEFEF");*/
  
              json.features.forEach(function(w) {
                w.properties.startups = 0;
                data.forEach(function(v) {
                  if (v["Country"] === w.properties.name) {
                    v.json_country = w.properties.name;
                    w.properties.startups += 1;
                  }
                });
              });
  
              var max_country = d3.max(json.features, function(w) {
                  return w.properties.startups
              })

  
  
              var countryCircleScale = d3.scaleSqrt()
              .domain([1,max_country])
              .range([2.6, 30]);
  
 
              json.features = json.features.filter(function(d) {
                return d.geometry.coordinates[0].length > 2
              })

              /*q.awaitAll(function (error) {
                if (error) throw error;
                setTimeout(function () {
                  mapG
                  .selectAll(".city-circle")
                  .data(data_city.filter(function(v) {
                    return v.cityLat != null
                  }))
                  .enter()
                  .append("circle")
                  .classed("city-circle", true)
                  .attr("r", function(d) {
                    if (d.values.length > 0) {
                      return countryCircleScale(d.values.length)
                    } 
                })
                  .attr("cx", function(d, i) {
                  return map.latLngToLayerPoint(new L.LatLng(d.cityLat, d.cityLng)).x
                })
                .attr("cy", function(d, i) {
                    return map.latLngToLayerPoint(new L.LatLng(d.cityLat, d.cityLng)).y
                })
                .style("cursor", "pointer")
                .attr("fill", "#7DCCFF")
                .attr("stroke", "#7DCCFF")
                .style("visibility", "hidden")
                .on("mouseover", city_hover)
                .on("click", city_click)

                })
                .attr("fill", "#7DCCFF")
                .attr("stroke", "#7DCCFF")
                .style("cursor", "pointer")
                .on("mouseover", function(d) {
                  country_hover(d)
                })
                .on("click", country_click)

                }, 2000);
                });*/

                mapG
                .selectAll(".country-circle")
                .data(json.features)
                .enter()
                .append("circle")
                .classed("country-circle", true)
                .attr("r", function(d) {
                  if (d.properties.startups > 0) {
                    return countryCircleScale(d.properties.startups);
                  }
                })
                .attr("cx", function(d, i) {
                  let arr = d.geometry.coordinates[0]
                  if (arr.length < 2) {
                    arr = d.geometry.coordinates[0][0]
                  }
                  if (arr != [0, 0]) {
                  return map.latLngToLayerPoint(new L.LatLng(center(arr)[1], center(arr)[0])).x
                  }

                })
                .attr("cy", function(d, i) {
                  let arr = d.geometry.coordinates[0]
                  if (arr.length < 2) {
                    arr = d.geometry.coordinates[0][0]
                  }
                  if (arr != [0,0]) {
                    return map.latLngToLayerPoint(new L.LatLng(center(arr)[1], center(arr)[0])).y
                }})
                .attr("fill", "#7DCCFF")
                .attr("stroke", "#7DCCFF")
                .style("cursor", "pointer")
                .on("mouseover", function(d) {
                  country_hover(d)
                })
                .on("click", country_click)




                function reset(e) {
                  d3.select(".map-tooltip").style("display", "none");
                mapG.selectAll(".country-circle")
                .attr("cx", function(d, i) {
                  let arr = d.geometry.coordinates[0]
                  if (arr.length < 2) {
                    arr = d.geometry.coordinates[0][0]
                  }
                  if (arr != [0, 0]) {
                  return map.latLngToLayerPoint(new L.LatLng(center(arr)[1], center(arr)[0])).x
                  }

                })
                .attr("cy", function(d, i) {
                  let arr = d.geometry.coordinates[0]
                  if (arr.length < 2) {
                    arr = d.geometry.coordinates[0][0]
                  }
                  if (arr != [0,0]) {
                    return map.latLngToLayerPoint(new L.LatLng(center(arr)[1], center(arr)[0])).y
                }

                })
                /*.style("visibility", function() {
                  if (e.target._zoom <= 3) {
                    return "visible"
                  } else {
                    return "hidden"
                  }
                })*/
                .attr("fill", "#7DCCFF")
                .attr("stroke", "#7DCCFF");

                 /*mapG.selectAll(".city-circle")
                  .attr("cx", function(d, i) {
                  return map.latLngToLayerPoint(new L.LatLng(d.cityLat, d.cityLng)).x
                })
                .attr("cy", function(d, i) {
                    return map.latLngToLayerPoint(new L.LatLng(d.cityLat, d.cityLng)).y
                })
                .style("visibility", function() {
                  if (e.target._zoom > 3) {
                    return "visible"
                  } else {
                    return "hidden"
                  }
                })
                .attr("fill", "#7DCCFF")
                .attr("stroke", "#7DCCFF");*/
              }

            map.on("zoom", function(e) {
              reset(e)
            })

            map.on("drag", function() {
              d3.select(".map-tooltip").style("display", "none");
            })



  
              // END::END
  
  

  
  
            // correct formatting of total funding values to numbers
            data.forEach(function(d) {
              d["Funding amount ($)"] = d["Funding amount ($)"].replace(
                /,/g,
                ""
              );
              if (d["Funding amount ($)"] === "" || d["Funding amount ($)"] === "Unfunded" || d["Funding amount ($)"] === "Funded") {
                d["Funding amount ($)"] = 0;
              }
  
              d["Funding amount ($)"] = (d["Funding amount ($)"])
              d["Primary SDG"] = d["Primary SDG"]
                .toLowerCase()
                .replace(/\//g, "_");
  
              /*desc.forEach(function(v) {
                if (
                  d["Primary SDG"] ===
                  v["Primary SDG"].toLowerCase().replace(/\//g, "_")
                ) {
                  d["Theme"] = v["Theme"];
                  d["Theme Definition"] = v["Theme Definition"];
                  d["Primary SDG Description"] = v["Description"]
                }
              });*/
            });
  
            /* var oppSpace_order = [
                "end of life care",
                "connected health",
                "non-invasive diagnostics",
                "chronic disease management",
                "growing wealth management",
                "will & succession planning",
                "smart agency"
              ];
  
              */

              /*function focusAreaSort(a, b) {
                var valA = focusAreaOrder.indexOf(a.replace(/_/g, "/"))
                var valB = focusAreaOrder.indexOf(b.replace(/_/g, "/"))
                return valA < valB ? -1 : valA > valB ? 1 : valA >= valB ? 0 : NaN;
              }
  
  
            //CHANGE HERE:
            function themeSort(a, b) {
              for (i = 0; i < themeOrder.length; i++) {
                if (a === themeOrder[i]) {
                  var valA = i;
                }
                if (b === themeOrder[i]) {
                  var valB = i;
                }
              }
              return valA < valB ? -1 : valA > valB ? 1 : valA >= valB ? 0 : NaN;
            }*/
          
            
            var focusAreaOrder = d3.nest()
              .key(function(d) {
                return d["Primary SDG"]
              })
              .entries(data)
              .sort(function(a, b) {
                console.log('a.key', a.key)
                console.log('a.key.slice(4,6)', a.key.slice(4,6).replace(/:/g,""))
                return d3.ascending(+a.key.slice(4,6).replace(/:/g,""), +b.key.slice(4,6).replace(/:/g,""))
              })
              .map(function(v) {
                return v.key
              })

              var focusAreaSort = focusAreaOrder

            data = data.filter(function(v) {
              return focusAreaOrder.indexOf(v["Primary SDG"]) >= 0
            })

  
            //CHANGE HERE:
            var focusAreaeBandColorScale = d3
            .scaleOrdinal()
            .domain(focusAreaOrder)
            .range([
              "#5FBDFB",
              //"#5FBDFB",
              "#EA3B66",
              "#EA3B66",
              "#EA3B66",
              //"#5DDA86",
              //"#5DDA86",
              // "#5DDA86",
              "#F5D932",
              "#F5D932"
              // "#F5D932"
            ]);
  
  
              
            /*
  
              function oppSpaceSort(a, b) {
                for (i = 0; i < oppSpace_order.length; i++) {
                  if (a === oppSpace_order[i]) {
                    var valA = i;
                  }
                  if (b === oppSpace_order[i]) {
                    var valB = i;
                  }
                }
                return valA < valB ? -1 : valA > valB ? 1 : valA >= valB ? 0 : NaN;
              }
  
              var oppSpaceBandColorScale = d3
                .scaleOrdinal()
                .domain(oppSpace_order)
                .range([
                  "#63C1AF",
                  "#63C1AF",
                  "#63C1AF",
                  "#63C1AF",
                  "#311C42",
                  "#311C42",
                  "#E74668"
                ]); */
  
            // need to fix.
            var fundingCategoryDomain = [
              "Undisclosed",
              "Seed",
              "Series A",
              "Series B",
              "Series C",
              "Series D",
              "Series E",
              "Public"
            ];
  
            var fundingCategoryRange = [
              "Undisclosed",
              "Seed",
              "Series A+",
              "Series A+",
              "Series A+",
              "Series A+",
              "Series A+",
              "Series A+"
            ];
  
            var fundingCategoryRangeUnique = [...new Set(fundingCategoryRange)];
  
            var fundingCategoryScale = d3
              .scaleOrdinal()
              .domain(fundingCategoryDomain)
              .range(fundingCategoryRange);
  
            var colors = ["#D75059", "#01AAFF", "#388659"];
  
            var nodeColorScale = d3
              .scaleOrdinal()
              .domain(fundingCategoryRangeUnique)
              .range(colors);
  
            var focusAreaSorted = d3
              .nest()
              .key(function(d) {
                return d["Primary SDG"];
              })
              .sortKeys(function(a, b) {
                let aVal = 0
                let bVal = 0
                focusAreaSort.forEach(function(v, index) {
                  if (a === v) {
                    aVal = index
                  }
                  if (b === v) {
                    bVal = index
                  }
                })
                return d3.ascending(aVal, bVal)
              })
              .rollup(function(v) {
                var totalFunding = d3.sum(v, function(d) {
                  return +d["Funding amount ($)"];
                });
                return totalFunding;
              })
              .entries(data);
  
  
            var count_by_focus_area = d3
              .nest()
              .key(function(d) {
                return d["Primary SDG"];
              })
              .sortKeys(function(a, b) {
                let aVal = 0
                let bVal = 0
                focusAreaSort.forEach(function(v, index) {
                  if (a === v) {
                    aVal = index
                  }
                  if (b === v) {
                    bVal = index
                  }
                })
                return d3.ascending(aVal, bVal)
              })
              .entries(data);
  
            /*var count_by_themes = d3
              .nest()
              .key(function(d) {
                return d["Theme"];
              })
              .sortKeys(themeSort)
              .entries(data);*/
  
            var count_by_maturity = d3
              .nest()
              .key(function(d) {
                return d["Maturity"];
              })
              .rollup(function(v) {
                return v.length;
              })
              .entries(data);
  
            var count_by_client = d3
              .nest()
              .key(function(d) {
                return d["Client Served"];
              })
              .sortKeys(d3.ascending)
              .rollup(function(v) {
                return v.length;
              })
              .entries(data);
  
            var count_by_funding_stage = d3
              .nest()
              .key(function(d) {
                return d["Funding Round"];
              })
              .rollup(function(v) {
                return v.length;
              })
              .entries(data);
  
            var count_by_year = d3
              .nest()
              .key(function(d) {
                return d["Founded"];
              })
              .sortKeys(d3.ascending)
              .rollup(function(v) {
                return v.length;
              })
              .entries(data);
  
            var yearList = [];
            count_by_year.forEach(function(d, i) {
              d.inner = 50 + (i * 250) / count_by_year.length;
              d.outer = 50 + ((i + 1) * 250) / count_by_year.length;
              yearList.push(d.key);
            });
  
            /* var fundingStage = [
                "Unfunded",
                "Seed",
                "Series A",
                "Series B",
                "Series C",
                "Series D",
                "Series E",
                "Public",
                "Acquired"
              ];
  
              var nodeSizeScale = d3
                .scaleOrdinal()
                .domain(fundingStage)
                .range([2, 2.75, 3.5, 4.25, 5, 5.2, 5.4, 5.6, 0]); */
  
            //var fundingAmount = ["$0-$10M", "$10-$20M", "$20M+"];
  
            /* var nodeSizeScale = d3
                .scaleOrdinal()
                .domain(fundingAmount)
                .range([2.6, 3.4, 4.2]);
  
              function nodeSizeScaleFunction(funding) {
                if (funding <= 10000000) {
                  return "$0-$10M";
                }
                if (funding > 10000000 && funding <= 20000000) {
                  return "$10-$20M";
                }
                if (funding > 20000000) {
                  return "$20M+";
                }
              } */
  
            var maturity_list = [
              { name: "Nascent", inner: 50, outer: 180 },
              { name: "Emerging", inner: 180, outer: 240 },
              { name: "Mature", inner: 240, outer: 300 }
            ];
  
            var backgroundArc = d3
              .arc()
              .innerRadius(maturity_list[0].inner)
              .outerRadius(maturity_list[2].outer);
  
            var nascentArc = d3
              .arc()
              .innerRadius(maturity_list[0].inner)
              .outerRadius(maturity_list[0].outer);
  
            var emergingArc = d3
              .arc()
              .innerRadius(maturity_list[1].inner)
              .outerRadius(maturity_list[1].outer);
  
            var matureArc = d3
              .arc()
              .innerRadius(maturity_list[2].inner)
              .outerRadius(maturity_list[2].outer);
  
            var themeArc = d3
              .arc()
              .innerRadius(330)
              .outerRadius(360);
  
            var chartPie = d3
              .pie()
              .value(function(d) {
                return d.value.value + 2000000000000;
              })
              .sort(function(a, b) {
                var valA = focusAreaOrder.indexOf(a.value.key.replace(/_/g, "/"))
                var valB = focusAreaOrder.indexOf(b.value.key.replace(/_/g, "/"))
                return valA < valB ? -1 : valA > valB ? 1 : valA >= valB ? 0 : NaN;
              });
  
            //CHANGE HERE:
            /*var outerChartPie = d3
              .pie()
              .value(function(d) {
                var number_of_opp_spaces = [
                  ...new Set(
                    d.value.values.map(function(v) {
                      return v["Opp Space"];
                    })
                  )
                ];
                return number_of_opp_spaces.length;
              })
              .sort(function(a, b) {
                return d3.ascending(a.value.key, b.value.key)
              });
  
            var outerChartPieData = outerChartPie(d3.entries(tempOrder));*/
  
            var chartPieData = chartPie(d3.entries(focusAreaSorted))
  
            var yearSegmentColorScale = d3
              .scaleOrdinal()
              .domain(yearList)
              .range(["#f4f4f4"]);
  
  
            clientList = [
              "All Startups"
            ];

            count_by_client.forEach(function(v) {
              if (v.key != "") {
                clientList.push(v.key)
              }
            })
  
            var clientSelector = d3
              .select("#client-selector")
              .selectAll("a")
              .data(clientList)
              .enter()
              .append("text")
              .html(function(d) {
                return "<a href='#'>" + d + "</a>";
              })
              .on("click", function(d) {
                filters.type = d
                update_opacity();
                clientFilter = d;
                d3.select(".dropdown-client").select(".dropbtn").html(d + " <i class='arrow down'> <\/i>")
              });

            // Bar Chart:
            barChartList = ["Amount of Funding", "Founded Year", "Maturity"]

            var barchartSelector = d3
            .select("#bar-chart-selector")
            .selectAll("a")
            .data(barChartList)
            .enter()
            .append("text")
            .html(function(d) {
              return "<a href='#'>" + d + "</a>";
            })
            .on("click", function(d) {
              update_bar(d)
            });

            /*themeFontData = categoryFontObject[0];
  
            var themeSegments = chartSVG
              .selectAll("theme-segments")
              .data(outerChartPieData)
              .enter()
              .append("path")
              .attr("d", themeArc)
              .attr("fill", "#247DC5")
              .style("stroke", "white")
              .style("stroke-width", "2px")
              .each(function(d, i) {
                var firstArcSection = /(^.+?)L/;
                var newArc = firstArcSection.exec(d3.select(this).attr("d"))[1];
                d.newArc = newArc.replace(/,/g, " ");
                d.percentage =
                    ((d.endAngle - d.startAngle) / 2 + d.startAngle) / 0.0628319;
                  if (d.percentage >= 100) {
                    d.percentage -= 100;
                  }
                if (d.percentage >= 25 && d.percentage <= 75) {
                  var startLoc = /M(.*?)A/;
                  var middleLoc = /A(.*?)0 0 1/;
                  var endLoc = /0 0 1 (.*?)$/;
                  d.newStart = endLoc.exec(d.newArc)[1];
                  d.newEnd = startLoc.exec(d.newArc)[1];
                  d.middleSec = middleLoc.exec(d.newArc)[1];
                  d.newArc =
                    "M" + d.newStart + "A" + d.middleSec + "0 0 0 " + d.newEnd;
                }
                d.hiddenArc = chartSVG
                  .append("path")
                  .attr("class", "hiddenDonutArcs")
                  .attr("id", function() {
                    return (
                      "hidden-theme-band" + d.data.key
                    );
                  })
                  .attr("d", d.newArc)
                  .style("fill", "none");
              })

              var themeLabels = chartSVG
                .selectAll(".theme-label-text")
                .data(outerChartPieData)
                .enter()
                .append("text")
                .attr("class", "label theme-label-text")
                .attr("dy", function(d) {
                  if (d.percentage >= 25 && d.percentage <= 75) {
                    return themeFontData.dy_upper;
                  }
                  return themeFontData.dy_lower;
                })
                .append("textPath")
                .attr("xlink:href", function(d, i) {
                  return (
                    "#" +
                    "hidden-theme-band" +
                    d.data.key
                  );
                })
                .attr("startOffset", "50%")
                .text(function(d) {
                  return d.data.value.key.toUpperCase();
                });*/
  
            var backgroundSegments = chartSVG
              .selectAll("background-segments")
              .data(chartPieData)
              .enter()
              .append("path")
              .attr("id", function(d) {
                return (
                  "background-segment-" +
                  d.data.value.key.replace(/ /g, "-").replace(/&/g, "and").replace(/:/g, "")
                );
              })
              .style("opacity", 0)
              .attr("d", backgroundArc);
  
            maturity_list.forEach(function(v) {
              var tmpArc = d3
                .arc()
                .innerRadius(v.inner)
                .outerRadius(v.outer);
  
              var tmpSegment = chartSVG
                .selectAll("mature-segments")
                .data(chartPieData)
                .enter()
                .append("path")
                .attr("class", "segment " + v.name.toLowerCase() + "-segments")
                .attr("id", function(d) {
                  return (
                    v.name.toLowerCase() +
                    "-" +
                    d.data.value.key.replace(/ /g, "-").replace(/&/g, "and").replace(/:/g, "") +
                    "-segment"
                  );
                })
                .attr("d", tmpArc)
                .attr("opacity", 1)
            });
  
            count_by_year.forEach(function(v) {
              var tmpArc = d3
                .arc()
                .innerRadius(v.inner)
                .outerRadius(v.outer);
  
              var tmpSegment = chartSVG
                .selectAll("year-segment")
                .data(chartPieData)
                .enter()
                .append("path")
                .attr("class", "segment " + "year-" + v.key + "-segments")
                .attr("id", function(d) {
                  return (
                    "year-" +
                    v.key +
                    "-" +
                    d.data.value.key.replace(/ /g, "-").replace(/&/g, "and").replace(/:/g, "") +
                    "-segment"
                  );
                })
                .attr("d", tmpArc)
                .attr("opacity", 1)
                .attr("fill", yearSegmentColorScale(v.key))
                .style("cursor", "pointer")
                /*.on("click", function(d) {
                  update_popup(d)
                })*/
            });
  
            var numSegments = focusAreaSorted.length;
  
            var segmentArc = d3
              .arc()
              .innerRadius(innerRadius)
              .outerRadius(outerRadius);
  
            var segmentLabelArc = d3
              .arc()
              .innerRadius(outerRadius)
              .outerRadius(outerRadius * 1.05);
  
            var segmentLabelBandArc = d3
              .arc()
              .innerRadius(outerRadius)
              .outerRadius(outerRadius * 1.095);

            oppSpaceFontData = categoryFontObject[1]

            var labelWidth = (2 * outerRadius * 1.095) / chartPieData.length;

              labelFontData = {
                limit: labelWidth * 0.35
              };
  
            var segmentsLabelBand = chartSVG
              .selectAll("path.segment-band")
              .data(chartPieData)
              .enter()
              .append("path")
              .classed("segment-band", true)
              .attr("d", segmentLabelBandArc)
              .attr("id", function(d) {
                return (
                  d.data.value.key.toLowerCase().replace(/ /g, "-").replace(/:/g, "") + "-band"
                );
              })
              .attr("fill", function(d) {
                return colorScale(d.data.value.key)
              })
              .each(function(d, i) {
                var firstArcSection = /(^.+?)L/;
                var newArc = firstArcSection.exec(d3.select(this).attr("d"))[1];
                d.newArc = newArc.replace(/,/g, " ");
                d.percentage =
                  ((d.endAngle - d.startAngle) / 2 + d.startAngle) / 0.0628319;
                if (d.percentage >= 100) {
                  d.percentage -= 100;
                }
                if (d.percentage >= 25 && d.percentage <= 75) {
                  var startLoc = /M(.*?)A/;
                  var middleLoc = /A(.*?)0 0 1/;
                  var endLoc = /0 0 1 (.*?)$/;
                  d.newStart = endLoc.exec(d.newArc)[1];
                  d.newEnd = startLoc.exec(d.newArc)[1];
                  d.middleSec = middleLoc.exec(d.newArc)[1];
                  d.newArc =
                    "M" + d.newStart + "A" + d.middleSec + "0 0 0 " + d.newEnd;
                }
                d.hiddenArc = chartSVG
                  .append("path")
                  .attr("class", "hiddenDonutArcs")
                  .attr("id", function() {
                    return (
                      "hidden-opp-space-band-" + d.data.value.key.replace(/_/g," ")
                    );
                  })
                  .attr("d", d.newArc)
                  .style("fill", "none");
              })
              .on("mouseover", function(d) {
                labelMouseOver(d);
                showOppSpaceTooltip(d)

              })
              .on("mouseout", function(d) {
                if (hoverOn === 0) {
                  labelMouseOut();
                }
              })
              /*.on("click", function(d) {
                  update_popup(d)
              }); */

              var oppSpaceLabels = chartSVG
                .selectAll(".opp-space-label-text")
                .data(chartPieData)
                .enter()
                .append("g")
                .selectAll(".test-class")
                .data(function(d) {
                  var limit = labelFontData.limit;

                  return textWrap(
                    d.data.value.key.toUpperCase().replace(/_/g," "),
                    d.percentage,
                    limit
                  );
                })
                .enter()
                .append("text")
                .attr("class", "label opp-space-label-text")
                .attr("dy", function(d, i) {
                  if (d.percentage >= 25 && d.percentage <= 75) {
                    if (d.lineLength === 1) {
                      return "-1.1em";
                    } else {
                      if (i === 0) {
                        return "-1.6em";
                      } else {
                        return "-0.6em";
                      }
                    }
                  } else {
                    if (d.lineLength === 1) {
                      return "1.8em";
                    } else {
                      if (i === 0) {
                        return "1.3em";
                      } else {
                        return "2.3em";
                      }
                    }
                  }
                })
                .append("textPath")
                .attr("xlink:href", function(d, i) {
                  return (
                    "#" +
                    "hidden-opp-space-band-" +
                    d.text_data.toLowerCase()
                  );
                })
                .attr("startOffset", "50%")
                .text(function(d) {
                  return d.data
                });
  
            var labelRadius = outerRadius * 1.055;
            var labelOtherRadius = outerRadius * 1.02;
  
            var labels = chartSVG.append("g").classed("labels", true);
            var labelsOther = chartSVG.append("g").classed("labels", true);
  
            labels
              .append("def")
              .append("path")
              .attr("id", "label-path")
              .attr(
                "d",
                "m0 " +
                  -labelRadius +
                  " a" +
                  labelRadius +
                  " " +
                  labelRadius +
                  " 0 1,1 -0.01 0"
              );
  
            labelsOther
              .append("def")
              .append("path")
              .attr("id", "label-other-path")
              .attr(
                "d",
                "m0 " +
                  -labelOtherRadius +
                  " a" +
                  labelOtherRadius +
                  " " +
                  labelOtherRadius +
                  " 0 1,1 -0.01 0"
              );
  
  /*
            labels
              .selectAll("text")
              .data(chartPieData)
              .enter()
              .append("text")
              .attr("class", "label-text")
              .append("textPath")
              .attr("xlink:href", "#label-path")
              .attr("startOffset", function(d, i) {
                var percentage =
                  ((d.endAngle - d.startAngle) / 2 + d.startAngle) / 0.0628319;
                return percentage + "%";
              })
              .text(function(d) {
                return label_wrap(d.data.value.key.toUpperCase())[0];
              });
  
            labelsOther
              .selectAll("text")
              .data(chartPieData)
              .enter()
              .append("text")
              .attr("class", "label-text")
              .append("textPath")
              .attr("xlink:href", "#label-other-path")
              .attr("startOffset", function(d, i) {
                var percentage =
                  ((d.endAngle - d.startAngle) / 2 + d.startAngle) / 0.0628319;
                return percentage + "%";
              })
              .text(function(d) {
                var result = label_wrap(d.data.value.key.toUpperCase());
                if (result.length > 2) {
                  return result[1] + " " + result[2];
                } else {
                  return result[1];
                }
              }); */
  
            var labelThemeRadius = outerRadius + 40;
  
            var labelsTheme = chartSVG.append("g").classed("labels-theme", true);
  
            labelsTheme
              .append("def")
              .append("path")
              .attr("id", "labels-theme-path")
              .attr(
                "d",
                "m0 " +
                  -labelThemeRadius +
                  " a" +
                  labelThemeRadius +
                  " " +
                  labelThemeRadius +
                  " 0 1,1 -0.01 0"
              );
            /*
            labelsTheme
              .selectAll("text")
              .data(outerChartPieData)
              .enter()
              .append("text")
              .attr("class", "labels-theme-text")
              .append("textPath")
              .attr("xlink:href", "#labels-theme-path")
              .attr("startOffset", function(d, i) {
                var percentage =
                  ((d.endAngle - d.startAngle) / 2 + d.startAngle) / 0.0628319;
                return percentage + "%";
              })
              .text(function(d) {
                return d.data.value.key.toUpperCase();
              }); */
  

  
            var keyOther = keySVG
              .selectAll("g.key-other")
              .data(fundingCategoryRangeUnique)
              .enter()
              .append("g")
              .attr("transform", function(d, i) {
                var h = keySize + keySpacing;
                var offset = 0;
                var horz = -50;
                var vert = i * h - offset - 90;
                return "translate(" + horz + "," + vert + ")";
              });
  
            var keyAcquired = keySVG
              .append("g")
              .attr("transform", "translate(-45,-30)");
  
            keyAcquired
              .append("rect")
              .classed("key-item-other", true)
              .attr("width", 8.8)
              .attr("height", 8.8)
              .attr("fill", "#FFFD82")
              .attr("x", -4)
              .attr("y", 3)
              .attr("transform", "translate(0, -7) rotate(45)")
              .on("mouseover", function(d) {
                keyMouseOver("Acquired", "acquired");
              })
              .on("mouseout", keyMouseOut)
              .on("click", function(d) {
                if (filterKey === "acquired") {
                  filterKey = "";
                  updateNodes("key", filterKey);
                } else {
                  filterKey = "acquired";
                  updateNodes("key", filterKey);
                }
              });
  
            keyAcquired
              .append("text")
              .text("Acquired")
              .classed("key-labels key-label", true)
              .attr("dx", "1.3em")
              .attr("dy", "0.2em")
              .on("mouseover", function() {
                keyMouseOver("Acquired", "acquired");
              })
              .on("mouseout", keyMouseOut)
              .on("click", function(d) {
                if (filterKey === "acquired") {
                  filterKey = "";
                  updateNodes("key", filterKey);
                } else {
                  filterKey = "acquired";
                  updateNodes("key", filterKey);
                }
              });
  
            keyOther
              .append("circle")
              .classed("key-item-other", true)
              .attr("r", 4.4)
              .attr("fill", function(d) {
                return nodeColorScale(d);
              })
              .on("mouseover", function(d) {
                keyMouseOver(d, "color");
              })
              //.on("mouseout", keyMouseOut)
              .on("click", function(d) {
                if (filterKey === d) {
                  filterKey = "";
                  updateNodes("key", filterKey);
                } else {
                  filterKey = d;
                  updateNodes("key", filterKey);
                }
              });
  
            keyOther
              .append("text")
              .text(function(d) {
                return d;
              })
              .classed("key-labels key-label", true)
              .attr("dx", "1.8em")
              .attr("dy", "0.35em")
              .on("mouseover", function(d) {
                keyMouseOver(d, "color");
              })
              .on("mouseout", keyMouseOut)
              .on("click", function(d) {
                if (filterKey === d) {
                  filterKey = "";
                  updateNodes("key", filterKey);
                } else {
                  filterKey = d;
                  updateNodes("key", filterKey);
                }
              });
  
            keyActivity = keySVG
              .append("g")
              .attr("transform", "translate(-50,-90)")
              .style("display", "none");
  
            keyActivity
              .append("polygon")
              .classed("key-item-other", true)
              .attr("id", "activity-key")
              .attr("points", [
                [0, -4.7],
                [-4.2, 3.7],
                [4.2, 3.7]
              ])
              .attr("dy", -10)
              .attr("dx", 10)
              .attr("fill", "#7C436A")
              .attr("opacity", function() {
                if (filterKey === "") {
                  return 1;
                } else {
                  return 0.3;
                }
              })
              .on("mouseover", function() {
                keyMouseOver("", "activity");
              })
              .on("mouseout", keyMouseOut)
              .on("click", function() {
                if (filterKey === "activity") {
                  filterKey = "";
                  updateNodes("", filterKey);
                } else {
                  filterKey = "activity";
                  updateNodes("", filterKey);
                }
              });
  
            keyActivity
              .append("text")
              .text("Activity")
              .classed("key-labels key-label", true)
              .attr("id", "activity-key-label")
              .attr("dx", "1.8em")
              .attr("dy", "0.3em")
              .attr("opacity", function() {
                if (filterKey === "") {
                  return 1;
                } else {
                  return 0.3;
                }
              })
              .on("mouseover", function() {
                keyMouseOver("", "activity");
              })
              .on("mouseout", keyMouseOut)
              .on("click", function() {
                if (filterKey === "activity") {
                  filterKey = "";
                  updateNodes("", filterKey);
                } else {
                  filterKey = "activity";
                  updateNodes("", filterKey);
                }
              });
  
            keyInvestment = keySVG
              .append("g")
              .attr("transform", "translate(-50,120)")
              .style("display", "none");
  
            keyInvestment
              .append("circle")
              .classed("key-item-other", true)
              .attr("id", "investment-key")
              .attr("cx", 0)
              .attr("cy", 0)
              .attr("r", 4.4)
              .attr("dy", -10)
              .attr("dx", 10)
              .attr("fill", "none")
              .attr("opacity", function() {
                if (filterKey === "") {
                  return 1;
                } else {
                  return 0.3;
                }
              });
  
            keyInvestment
              .append("text")
              .text("Investment")
              .classed("key-labels key-label", true)
              .attr("id", "investment-key-label")
              .attr("dx", "1.8em")
              .attr("dy", "0.3em")
              .attr("opacity", function() {
                if (filterKey === "") {
                  return 1;
                } else {
                  return 0.3;
                }
              });
  
            var keyTitle = keySVG
              .append("text")
              .attr("class", "key-title")
              .text("Funding Key:")
              .attr("y", -110)
              .attr("x", -60);
  
            /* var switchBtn = svg
                .append("rect")
                .attr("id", "switch-button")
                .attr("x", width / 2 - 45)
                .attr("y", function() {
                  return (
                    keyAcquired.node().transform.animVal.getItem(0).matrix.f + 36
                  );
                })
                .attr("width", 90)
                .attr("height", 30)
                .on("click", function() {
                  switchRadial();
                });
  
              var switchBtnLabel = svg
                .append("text")
                .attr("id", "switch-button-label")
                .attr("x", width / 2)
                .attr("y", function() {
                  return +d3.select("#switch-button").attr("y") + 20;
                })
                .text("Maturity")
                .attr("fill", "white"); */
  
            var nascentLabelRadius = maturity_list[0].outer - 15;
            var emergingLabelRadius = maturity_list[1].outer - 15;
            var matureLabelRadius = maturity_list[2].outer - 15;
  
            var nascentLabel = chartSVG
              .append("g")
              .classed("maturity-labels", true);
  
            nascentLabel
              .append("def")
              .append("path")
              .attr("id", "nascent-label-path")
              .attr(
                "d",
                "m " +
                  -nascentLabelRadius +
                  " 0 a 50 50 0 1 1 " +
                  2 * nascentLabelRadius +
                  " 0"
              );
  
            nascentLabel
              .append("text")
              .attr("class", "maturity-label-text")
              .attr("id", "nascent-label-path-text")
              .append("textPath")
              .attr("xlink:href", "#nascent-label-path")
              .attr("startOffset", "50%")
              .text("Nascent");
  
            var emergingLabel = chartSVG
              .append("g")
              .classed("maturity-labels", true);
  
            emergingLabel
              .append("def")
              .append("path")
              .attr("id", "emerging-label-path")
              .attr(
                "d",
                "m " +
                  -emergingLabelRadius +
                  " 0 a 50 50 0 1 1 " +
                  2 * emergingLabelRadius +
                  " 0"
              );
  
            emergingLabel
              .append("text")
              .attr("class", "maturity-label-text")
              .attr("id", "emerging-label-path-text")
              .append("textPath")
              .attr("xlink:href", "#emerging-label-path")
              .attr("startOffset", "50%")
              .text("Emerging");
  
            count_by_year.forEach(function(d, i) {
              this["year" + d.key + "LabelRadius"] = d.outer - 10;
  
              this["year" + d.key + "Label"] = chartSVG
                .append("g")
                .classed("year-labels", true);
  
              this["year" + d.key + "Label"]
                .append("def")
                .append("path")
                .attr("id", "year-" + d.key + "-label-path")
                .attr(
                  "d",
                  "m " +
                    -this["year" + d.key + "LabelRadius"] +
                    " 0 a 50 50 0 1 1 " +
                    2 * this["year" + d.key + "LabelRadius"] +
                    " 0"
                );
              d.fn = this["year" + d.key + "Label"];

                  d.fn
                    .append("text")
                    .attr("class", "year-label-text")
                    .attr("id", "year-" + d.key + "-label-path-text")
                    .append("textPath")
                    .attr("xlink:href", "#year-" + d.key + "-label-path")
                    .attr("startOffset", "50%")
                    .text(d.key);
            });
  
            var matureLabel = chartSVG
              .append("g")
              .classed("maturity-labels", true);
  
            matureLabel
              .append("def")
              .append("path")
              .attr("id", "mature-label-path")
              .attr(
                "d",
                "m " +
                  -matureLabelRadius +
                  " 0 a 50 50 0 1 1 " +
                  2 * matureLabelRadius +
                  " 0"
              );
  
            matureLabel
              .append("text")
              .attr("class", "maturity-label-text")
              .attr("id", "mature-label-path-text")
              .append("textPath")
              .attr("xlink:href", "#mature-label-path")
              .attr("startOffset", "50%")
              .text("Mature");
  
            maturity_list_elements = [
              { name: "Nascent", fn: nascentLabel },
              { name: "Emerging", fn: emergingLabel },
              { name: "Mature", fn: matureLabel }
            ];
  
            maturity_list.forEach(function(d) {
              var id = "#" + d.name.toLowerCase() + "-label-path-text";
              d3.select(id).remove();
            });
  
            count_by_year.forEach(function(d) {
              chartPieData.forEach(function(v) {
                d3.select(
                  "#year-" +
                    d.key +
                    "-" +
                    v.data.value.key.replace(/ /g, "-").replace(/&/g, "and").replace(/:/g, "") +
                    "-segment"
                ).attr("opacity", 1);
              });
            });

            var nodeData = d3
            .nest()
            .key(function(d) {
              return d["Primary SDG"];
            })
            .key(function(d) {
              return d["Maturity"];
            })
            .rollup(function(v) {
              return v.length;
            })
            .entries(data);

            var nodeSecondData = d3
              .nest()
              .key(function(d) {
                return d["Primary SDG"];
              })
              .key(function(d) {
                return d["Founded"];
              })
              .rollup(function(v) {
                return v.length;
              })
              .entries(data);
  
            var nodeThirdData = d3
              .nest()
              .key(function(d) {
                return d["Primary SDG"];
              })
              .key(function(d) {
                return d["Founded"];
              })
              .rollup(function(v) {
                return v.length;
              })
              .entries(data);

            
            nodeData.forEach(function(v) {
              indexTracker[v.key] = {}
              v.values.forEach(function(w) {
                indexTracker[v.key][w.key] = {'slot': 1}
              })
            })

            nodeSecondData.forEach(function(v) {
              indexTrackerYear[v.key] = {}
              v.values.forEach(function(w) {
                indexTrackerYear[v.key][w.key] = {'slot': 1}
              })
            })

            var nodeList = [];
            data.forEach(function(d) {
                for (i = 0; i < chartPieData.length; i++) {
                  if (
                    d["Primary SDG"] === chartPieData[i].data.value.key
                  ) {
                    var tmp_startAngleMin = chartPieData[i].startAngle
                    var tmp_endAngleMax = chartPieData[i].endAngle
                    break;
                  }
                }
                for (i = 0; i < maturity_list.length; i++) {
                  if (d["Maturity"] === maturity_list[i]["name"]) {
                    tmp_innerRadiusMin = maturity_list[i]["inner"]
                    tmp_outerRadiusMax = maturity_list[i]["outer"]
                    break;
                  }
                }

                for (i = 0; i < nodeData.length; i++) {
                  if (nodeData[i].key === d["Primary SDG"]) {
                    for (j = 0; j < nodeData[i].values.length; j++) {
                      if (nodeData[i].values[j].key === d["Maturity"]) {

                        var congestion = calcCongestion(
                          tmp_startAngleMin,
                          tmp_endAngleMax,
                          tmp_innerRadiusMin,
                          tmp_outerRadiusMax,
                          radiusSize,
                          nodeData[i].values[j].value
                        )
                        if (congestion > 1) {
                           d.results = assignRandom(
                            tmp_startAngleMin,
                            tmp_endAngleMax,
                            tmp_innerRadiusMin,
                            tmp_outerRadiusMax,
                            congestion,
                            nodeList
                          );  
                          
                        } else {
                          d.results = assignNonRandom(
                            d,
                            tmp_startAngleMin,
                            tmp_endAngleMax,
                            tmp_innerRadiusMin,
                            tmp_outerRadiusMax,
                            nodeData[i].values[j]
                          )
                          indexTracker[d["Primary SDG"]][d["Maturity"]]["slot"] += 1
                        }


                        /* var results = assignRandom(
                          tmp_startAngleMin,
                          tmp_endAngleMax,
                          tmp_innerRadiusMin,
                          tmp_outerRadiusMax,
                          nodeList
                        ); */
                      }
                    }
                  }
                }

                if (d.results) {
                d.x = d.results[0];
                d.y = d.results[1];
                } else {
                d.x = 0//results[0];
                d.y = 0//results[1];
                }
                d.opacity = 1;
              });

  
            var nodeSecondList = [];
            data.forEach(function(d) {
              for (i = 0; i < chartPieData.length; i++) {
                if (d["Primary SDG"] === chartPieData[i].data.value.key) {
                  var tmp_startAngleMin = chartPieData[i].startAngle
                  var tmp_endAngleMax = chartPieData[i].endAngle
                  break;
                }
              }
  
              for (i = 0; i < count_by_year.length; i++) {
                if (d["Founded"] === count_by_year[i].key) {
                  tmp_innerRadiusMin = count_by_year[i]["inner"]
                  tmp_outerRadiusMax = count_by_year[i]["outer"]
                  break;
                }
              }
              for (i = 0; i < nodeSecondData.length; i++) {
                if (nodeSecondData[i].key === d["Primary SDG"]) {
                  for (j = 0; j < nodeSecondData[i].values.length; j++) {
                    if (nodeSecondData[i].values[j].key === d["Founded"]) {
                        var congestion = calcCongestion(
                          tmp_startAngleMin,
                          tmp_endAngleMax,
                          tmp_innerRadiusMin,
                          tmp_outerRadiusMax,
                          radiusSize,
                          nodeSecondData[i].values[j].value
                        )
                        if (congestion > 5) {
                           d.resultsYear = assignRandom(
                            tmp_startAngleMin,
                            tmp_endAngleMax,
                            tmp_innerRadiusMin,
                            tmp_outerRadiusMax,
                            congestion,
                            nodeList
                          );  
                        } else {
                           d.resultsYear = assignNonRandomYear(
                            d,
                            tmp_startAngleMin,
                            tmp_endAngleMax,
                            tmp_innerRadiusMin,
                            tmp_outerRadiusMax,
                            nodeSecondData[i].values[j]
                          )
                          indexTrackerYear[d["Primary SDG"]][d["Founded"]]["slot"] += 1

                        }
                    }
                  }
                }
              }
                if (d.resultsYear) {
                d.yearX = d.resultsYear[0];
                d.yearY = d.resultsYear[1];
                } else {
                d.yearX = 0//results[0];
                d.yearY = 0//results[1];
                }
            });
            /*
              var nodeThirdList = [];
                data.forEach(function(d) {
                  //console.log(d)
                  for (i = 0; i < chartPieData.length; i++) {
                    if (d["Focus Area"] === chartPieData[i].data.value.key) {
                      var tmp_startAngleMin = chartPieData[i].startAngle + 0.025;
                      var tmp_endAngleMax = chartPieData[i].endAngle - 0.025;
                      break;
                    }
                  }
  
                  for (i = 0; i < count_by_year.length; i++) {
                    if (d["Founded"] === count_by_year[i].key) {
                      //console.log('InnerRadius:', count_by_year[i]['inner'])
                      //console.log('OuterRadius:', count_by_year[i]['outer'])
                      tmp_innerRadiusMin = count_by_year[i]["inner"] + 6;
                      tmp_outerRadiusMax = count_by_year[i]["outer"] - 6;
                      break;
                    }
                  }
                  for (i = 0; i < nodeThirdData.length; i++) {
                    if (nodeThirdData[i].key === d["Focus Area"]) {
                      for (j = 0; j < nodeThirdData[i].values.length; j++) {
                        if (nodeThirdData[i].values[j].key === d["Founded"]) {
                          var results = assignRandom(
                            tmp_startAngleMin,
                            tmp_endAngleMax,
                            tmp_innerRadiusMin,
                            tmp_outerRadiusMax,
                            nodeThirdList
                          );
                        }
                      }
                    }
                  }
                  d.yearX = results[0];
                  d.yearY = results[1];
                });
                */
  
            //switchRadial();
  
            d3.select("#switch-button-maturity").on("click", function() {
                if (radial !== "maturity") {
                  switchRadial();
                  //d3.select(this).attr("background-color", "#e74668")
                  //d3.select("#switch-button-year").attr("background-color", "#8e8e8e")
                }
              });

              d3.select("#switch-button-year").on("click", function() {
                if (radial !== "year") {
                  switchRadial();
                  //d3.select(this).attr("background-color", "#e74668")
                  //d3.select("#switch-button-maturity").attr("background-color", "#8e8e8e")
                }
              });

              d3.select("#button-16").on("change", function() {
                switchRadial();
              });
              d3.select("#button-17").on("change", function() {
                if (geoFilter === "All Startups") {
                  filters.geotype = "African"
                  update_opacity()
                  geoFilter = "African"
                } else {
                  filters.geotype = "All Startups"
                  update_opacity()
                  geoFilter = "All Startups"
                }
              });
  
            var CompetitorMode = 0;

            var radiusSize = 0.1;

            var nodes = chartSVG
              .selectAll("nodes")
              .data(data)
              .enter()
              .append("a")
              .attr("xlink:href", function(d) {
                return formatURL(d.Website)
              })
              .attr("target", "_blank")
              .append("circle")
              .each(function(d) {
                d.hide = false;
              })
              .attr("class", "nodes")
              .attr("r", function(d) {
                if (
                    d["Funding Round"] !== "Acquired"
                ) {
                  return nodeRadius;
                }
              })
              .attr("cx", function(d) {
                return d.yearX;
              })
              .attr("cy", function(d) {
                return d.yearY;
              })
              .attr("fill", function(d) {
                return nodeColorScale(
                    fundingCategoryScale(d["Funding Round"])
                  );
              })
              .on("mouseover", function(d) {
                //nodeMouseOver(d);
                showNodeTooltip(d)
              })
              .on("mouseout", hideNodeTooltip);
  
            var nodes_activity = chartSVG
              .selectAll("nodes-activity")
              .data(data)
              .enter()
              .append("a")
              .attr("xlink:href", function(d) {
                return formatURL(d.Website)
              })
              .attr("target", "_blank")
              .append("polygon")
              .attr("class", "nodes nodes-activity")
              .attr("id", function(d) {
                return d["Startup Name"].toLowerCase().replace(/ /g, "-");
              })
              .attr("points", function(d) {
                var points = [
                  [d.yearX, d.yearY],
                  [d.yearX, d.yearY],
                  [d.yearX, d.yearY]
                ];
                return points;
              })
              .attr("fill", "#7C436A")
              .on("mouseover", function(d) {
                //nodeMouseOver(d);
                showNodeTooltip(d)
              })
              .on("mouseout", hideNodeTooltip);
  
            var nodes_acquired = chartSVG
              .selectAll("nodes-acquired")
              .data(data)
              .enter()
              .append("a")
              .attr("xlink:href", function(d) {
                return formatURL(d.Website)
              })
              .attr("target", "_blank")
              .append("rect")
              .attr("class", "nodes nodes-acquired")
              .attr("id", function(d) {
                return d["Startup Name"].toLowerCase().replace(/ /g, "-");
              })
              .attr("width", function(d) {
                if (d["Funding Round"] === "Acquired") {
                  return nodeOtherWidth
                } else {
                  return 0;
                }
              })
              .attr("height", function(d) {
                if (d["Funding Round"] === "Acquired") {
                  return nodeOtherWidth
                } else {
                  return 0;
                }
              })
              .attr("x", 0)
              .attr("y", 0)
              .attr("fill", "#FFFD82")
              .attr("transform", function(d) {
                return "translate(" + d.yearX + "," + d.yearY + ")    rotate(45)";
              })
              .on("mouseover", function(d) {
                //nodeMouseOver(d);
                showNodeTooltip(d)
              })
              .on("mouseout", hideNodeTooltip);
  
            /* function keyMouseOver(data, type) {
                nodes.attr("opacity", function(d) {
                  if (nodeSizeScaleFunction(d["$ Total Funding "]) === data) {
                    return 1;
                  } else {
                    return 0.3;
                  }
                });
                nodes_acquired.attr("opacity", 0.3);
              } */
  
            function updateNodes(type, filterKey) {
              if (filterKey === "") {
                data.forEach(function(d) {
                  d.opacity = 1;
                });
                nodes.attr("opacity", 1);
                nodes_acquired.attr("opacity", 1);
                nodes_activity.attr("opacity", 1);
                keyOther.attr("opacity", 1);
                keyAcquired.attr("opacity", 1);
                segmentsLabelBand.attr("opacity", function(d) {
                  d.opacity = 1;
                  return d.opacity;
                });
                keyActivity.attr("opacity", 1);
              }
  
              if (filterKey === "acquired") {
                nodes.attr("opacity", function(d) {
                  if (d["Funding Round"] !== "Acquired") {
                    d.opacity = 0.3;
                  }
                  return d.opacity;
                });
  
                nodes_acquired.attr("opacity", function(d) {
                  if (d["Funding Round"] === "Acquired") {
                    d.opacity = 1;
                  }
                  return d.opacity;
                });
  
                nodes_activity.attr("opacity", function(d) {
                  if (d["Funding Round"] !== "Acquired") {
                    d.opacity = 0.3;
                  }
                  return d.opacity;
                });
  
                keyOther.attr("opacity", 0.3);
  
                keyAcquired.attr("opacity", 1);
  
                keyActivity.attr("opacity", 0.3);
              }
  
              if (filterKey === "activity") {
                nodes.attr("opacity", function(d) {
                  if (
                    d["Activity/Acquisition Time"] != "" &&
                    d["Funding Round"] !== "Acquired"
                  ) {
                    d.opacity = 1;
                  } else {
                    d.opacity = 0.3;
                  }
                  return d.opacity;
                });
  
                nodes_activity.attr("opacity", function(d) {
                  if (d["Activity/Acquisition Time"] != "") {
                    d.opacity = 1;
                  } else {
                    d.opacity = 0.3;
                  }
                  return d.opacity;
                });
  
                nodes_acquired.attr("opacity", function(d) {
                  if (d["Activity/Acquisition Time"] != "") {
                    d.opacity = 1;
                  } else {
                    d.opacity = 0.3;
                  }
                  return d.opacity;
                });
                keyOther.attr("opacity", 0.3);
  
                keyAcquired.attr("opacity", 0.3);
  
                keyActivity.attr("opacity", 1);
              }
  
              if (
                filterKey !== "acquired" &&
                filterKey !== "" &&
                type === "key"
              ) {
                
                nodes.attr("opacity", function(v) {
                  if (fundingCategoryScale(v["Funding Round"]) === filterKey) {
                    v.opacity = 1;
                  } else {
                    v.opacity = 0.3;
                  }
                  return v.opacity;
                });
  
                nodes_acquired.attr("opacity", function(d) {
                  if (d["Funding Round"] === "Acquired") {
                    d.opacity = 0.3;
                  }
                  return d.opacity;
                });
  
                nodes_activity.attr("opacity", function(d) {
                  if (d["Activity/Acquisition Time"] != "") {
                    d.opacity = 0.3;
                  }
                  return d.opacity;
                });
  
                keyOther.attr("opacity", function(d) {
                  if (d === filterKey) {
                    return 1;
                  } else {
                    return 0.3;
                  }
                });
  
                keyAcquired.attr("opacity", 0.3);
  
                keyActivity.attr("opacity", 0.3);
              }
              if (type === "focus area" && filterKey !== "") {
                nodes.attr("opacity", function(d) {
                  if (d["Primary SDG"].toLowerCase() !== filterKey) {
                    d.opacity = 0.3;
                  } else {
                    d.opacity = 1;
                  }
                  return d.opacity;
                });
  
                nodes_acquired.attr("opacity", function(d) {
                  if (d["Primary SDG"].toLowerCase() !== filterKey) {
                    d.opacity = 0.3;
                  } else {
                    d.opacity = 1;
                  }
                  return d.opacity;
                });
  
                //segment_data.data.value.key
                segmentsLabelBand.attr("opacity", function(d) {
                  if (d.data.value.key === filterKey) {
                    d.opacity = 1;
                  } else {
                    d.opacity = 0.3;
                  }
                  return d.opacity;
                });
              }
            }
            
            /*
            function switch_competitors() {
              if (CompetitorMode === 1) {
                keyOther.style("display", "none");
                keyInvestment.style("display", "");
                keyActivity.style("display", "");
                keyAcquired.attr("transform", "translate(-45,-70)");
              } else {
                keyActivity.style("display", "none");
                keyInvestment.style("display", "none");
                keyOther.style("display", "");
                keyAcquired.attr("transform", "translate(-45,-30)");
              }
  
              nodes
                .transition()
                .duration(animationDuration * 0.7)
                .attrTween("r", function(d) {
                  var startR = d3.select(this).attr("r");
                  if (
                    (d["Competitor"] === "" || d["Competitor Category"] != "") &&
                    CompetitorMode === 1
                  ) {
                    d.hide = true;
                  }
                  if (CompetitorMode === 0) {
                    d.hide = false;
                  }
                  if (
                    d.hide === true ||
                    d["Funding Round"] === "Acquired" ||
                    d["Competitor Category"] != ""
                  ) {
                    endR = 0;
                  } else {
                    endR = 3.4;
                  }
                  var i = d3.interpolate(startR, endR);
                  return function(t) {
                    return i(t);
                  };
                });
  
              nodes_activity
                .transition()
                .duration(animationDuration * 0.7)
                .attrTween("points", function(d) {
                  var currentPoints = d3.select(this).attr("points");
                  var pList = currentPoints.split(",");
                  var startPoints = [
                    [+pList[0], +pList[1]],
                    [+pList[2], +pList[3]],
                    [+pList[4], +pList[5]]
                  ];
                  if (radial === "maturity") {
                    if (
                      d["Competitor Category"] == "Activity" &&
                      CompetitorMode === 1
                    ) {
                      var endPoints = [
                        [d.x, d.y - 4.7],
                        [d.x - 4.2, d.y + 3.7],
                        [d.x + 4.2, d.y + 3.7]
                      ];
                    } else {
                      var endPoints = [
                        [d.x, d.y],
                        [d.x, d.y],
                        [d.x, d.y]
                      ];
                    }
                  } else {
                    if (
                      d["Competitor Category"] == "Activity" &&
                      CompetitorMode === 1
                    ) {
                      var endPoints = [
                        [d.yearX, d.yearY - 4.7],
                        [d.yearX - 4.2, d.yearY + 3.7],
                        [d.yearX + 4.2, d.yearY + 3.7]
                      ];
                    } else {
                      var endPoints = [
                        [d.yearX, d.yearY],
                        [d.yearX, d.yearY],
                        [d.yearX, d.yearY]
                      ];
                    }
                  }
  
                  var i = d3.interpolateArray(startPoints, endPoints);
                  return function(t) {
                    return i(t);
                  };
                });
  
              nodes_acquired
                .transition()
                .duration(animationDuration * 0.7)
                .attrTween("width", function(d) {
                  var startWidth = d3.select(this).attr("width");
                  if (d.hide === true || d["Funding Round"] !== "Acquired") {
                    endWidth = 0;
                  } else {
                    endWidth = 8.8;
                  }
                  var i = d3.interpolate(startWidth, endWidth);
                  return function(t) {
                    return i(t);
                  };
                })
                .attrTween("height", function(d) {
                  var startHeight = d3.select(this).attr("height");
                  if (d.hide === true || d["Funding Round"] !== "Acquired") {
                    endHeight = 0;
                  } else {
                    endHeight = 8.8;
                  }
                  var i = d3.interpolate(startHeight, endHeight);
                  return function(t) {
                    return i(t);
                  };
                })
                .attrTween("y", function(d) {
                  var startY = d3.select(this).attr("y");
                  if (d.hide === true || d["Funding Round"] !== "Acquired") {
                    endY = 7;
                  } else {
                    endY = 0;
                  }
                  var i = d3.interpolate(startY, endY);
                  return function(t) {
                    return i(t);
                  };
                });
            } */

            function textWrap(text_data, percentage, limit = 6) {
              result = [];
              if (text_data.length > limit) {
                if (text_data.length >= (limit -1)* 2) {
                    a = text_data.substr(0, limit).lastIndexOf(" ")
                    y = text_data.substr(0, a)
                    a_rem = text_data.substr(a + 1)
                    b = a_rem.substr(0, limit).lastIndexOf(" ")
                    z = a_rem.substr(0, b)
                    result.push({
                      data: y,
                      text_data: text_data,
                      percentage: percentage,
                      lineLength: 2
                    });
                    result.push({
                      data: z + "...",
                      text_data: text_data,
                      percentage: percentage,
                      lineLength: 2
                    });
                } else {
                var tmp_limit = text_data.length / 2 - 4;
                var lines = dummy(text_data, tmp_limit);

                lines.forEach(function(d) {
                  if (d.length > 1) {
                    d = d.join(" ");
                  }
                  if (d !== "") {
                    result.push({
                      data: d,
                      text_data: text_data,
                      percentage: percentage,
                      lineLength: lines.length
                    });
                  }
                });
                }
              } else {
                result.push({
                  data: text_data,
                  text_data: text_data,
                  percentage: percentage,
                  lineLength: 1
                });
              }
              var maxLength = d3.max(result, function(d) {
                return d.data.length;
              });
              result.forEach(function(d) {
                d.MaxLength = maxLength;
              });
              return result;
            }

                  function dummy(text, limit) {
        words = text.split(" ");
        words_rev = temporarySwap([...words]);
        lines = [];
        lines_rev = [];

        current_seq_len = 0;
        current_seq = [];
        words.forEach(function(d) {
          current_seq_len += d.length;
          current_seq.push(d.replace(/�۪/g, "'"));
          if (current_seq_len > limit) {
            lines.push(current_seq);
            current_seq_len = 0;
            current_seq = [];
          }
        });
        if (current_seq.length > 0) {
          lines.push(current_seq);
          current_seq_len = 0;
          current_seq = [];
        }

        current_seq_len = 0;
        current_seq = [];
        words_rev.forEach(function(d) {
          current_seq_len += d.length;
          current_seq.push(d.replace(/�۪/g, "'"));
          if (current_seq_len > limit) {
            lines_rev.push(temporarySwap(current_seq));
            current_seq_len = 0;
            current_seq = [];
          }
        });
        if (current_seq.length > 0) {
          lines_rev.push(temporarySwap(current_seq));
          current_seq_len = 0;
          current_seq = [];
        }
        if (lines.length === 3) {
          return temporarySwap(lines_rev);
        }
        if (lines_rev.length > lines.length && lines_rev.length !== 3) {
          return temporarySwap(lines_rev);
        }
        return lines;
      }

            function temporarySwap(array) {
        var left = null;
        var right = null;
        var length = array.length;
        for (left = 0; left < length / 2; left += 1) {
          right = length - 1 - left;
          var temporary = array[left];
          array[left] = array[right];
          array[right] = temporary;
        }
        return array;
      }
  
            function update_opacity() {

              type = filters.type
              geotype = filters.geotype
  
              nodes
                .transition()
                .duration(animationDuration * 0.7)
                .attrTween("r", function(d) {
                  var startR = d3.select(this).attr("r");
                  if (
                    (d["Client Served"] === type || type === "All Startups") &&
                    d["Funding Round"] !== "Acquired" &&
                    d.hide === false &&
                    (d["Global"] === geotype || geotype === "All Startups")
                  ) {
                    var endR = nodeRadius;
                  } else {
                    var endR = 0;
                  }
                  var i = d3.interpolate(startR, endR);
                  return function(t) {
                    return i(t);
                  };
                });
  
              nodes_activity
                .transition()
                .duration(animationDuration * 0.7)
                .attrTween("points", function(d) {
                  var currentPoints = d3.select(this).attr("points");
                  var pList = currentPoints.split(",");
                  var startPoints = [
                    [+pList[0], +pList[1]],
                    [+pList[2], +pList[3]],
                    [+pList[4], +pList[5]]
                  ];
  
                  if (
                    d["Activity/Acquisition Time"] != "" &&
                    CompetitorMode === 1 &&
                    (d["Client Served"] === type || type === "All Startups") &&
                    (d["Global"] === geotype || geotype === "All Startups")
                  ) {
                    var endPoints = [
                      [d.yearX, d.yearY - 4.7],
                      [d.yearX - 4.2, d.yearY + 3.7],
                      [d.yearX + 4.2, d.yearY + 3.7]
                    ];
                  } else {
                    var endPoints = [
                      [d.yearX, d.yearY],
                      [d.yearX, d.yearY],
                      [d.yearX, d.yearY]
                    ];
                  }
                  var i = d3.interpolateArray(startPoints, endPoints);
                  return function(t) {
                    return i(t);
                  };
                });
  
              nodes_acquired
                .transition()
                .duration(animationDuration * 0.7)
                .attrTween("width", function(d) {
                  var startWidth = d3.select(this).attr("width");
                  if (
                    (d["Client Served"] === type || type === "All Startups") &&
                    d["Funding Round"] === "Acquired" &&
                    d.hide === false &&
                    (d["Global"] === geotype || geotype === "All Startups")
                  ) {
                    var endWidth = nodeOtherWidth
                  } else {
                    var endWidth = 0;
                  }
                  var i = d3.interpolate(startWidth, endWidth);
                  return function(t) {
                    return i(t);
                  };
                })
                .attrTween("height", function(d) {
                  var startHeight = d3.select(this).attr("height");
                  if (
                    (d["Client Served"] === type || type === "All Startups") &&
                    d["Funding Round"] === "Acquired" &&
                    d.hide === false &&
                    (d["Global"] === geotype || geotype === "All Startups")
                  ) {
                    var endHeight = nodeOtherWidth
                  } else {
                    var endHeight = 0;
                  }
                  var i = d3.interpolate(startHeight, endHeight);
                  return function(t) {
                    return i(t);
                  };
                })
                .attrTween("y", function(d) {
                  var startY = d3.select(this).attr("y");
                  if (
                    (d["Client Served"] === type || type === "All Startups") &&
                    d["Funding Round"] === "Acquired" &&
                    d.hide === false &&
                    (d["Global"] === geotype || geotype === "All Startups")
                  ) {
                    var endY = 0;
                  } else {
                    var endY = nodeOtherWidth*1.5
                  }
                  var i = d3.interpolate(startY, endY);
                  return function(t) {
                    return i(t);
                  };
                });
            }

            function update_bar(type) {
                var margin = {top: 20, right: 20, bottom: 30, left: 40}
                d3.select(".svg-bar-container").html("")
                d3.select(".dropbtn-b").html("<i class='arrow down'> <\/i> " + type)


                var barSVG = d3.select(".svg-bar-container")
                .append("svg")
                .attr("width", bar_width)
                .attr("height", bar_height)
                .append("g")
                .attr("transform", "translate(" + (margin.left-50) + "," + margin.top + ")");

                if (type === "Amount of Funding") {

                    var fundHist = [{'name': '0-10K', 'lower_limit': 0, 'upper_limit': 10000, 'startups': 0},
                    {'name': '10K-100K', 'lower_limit': 10000, 'upper_limit': 100000, 'startups': 0},
                    {'name': '100K-1M', 'lower_limit': 100000, 'upper_limit': 1000000, 'startups': 0},
                    {'name': '1M-10M', 'lower_limit': 1000000, 'upper_limit': 10000000, 'startups': 0},
                    {'name': '10M-100M', 'lower_limit': 10000000, 'upper_limit': 100000000, 'startups': 0},
                    {'name': '100M+', 'lower_limit': 100000000, 'upper_limit': 100000000000, 'startups': 0},
                    ]

                    

                    bar_data.forEach(function(v) {
                      if (v.Funding != 0) {
                        if (v.Funding.slice(0,1) == "$") {
                          v.Funding = v.Funding.slice(1)
                        }
                      }
                        fundHist.forEach(function(w) {
                            if (v.Funding === "n/a") {
                                v.Funding = 0
                            }
                            if (v.Funding > w.lower_limit && v.Funding <= w.upper_limit) {
                                w.startups += 1
                            }
                        })
                    })

                    var maxVal = d3.max(fundHist, function(d) {
                        return d.startups
                    })

                    

                    var x = d3.scaleBand()
                    .domain(fundHist.map(function(d) {
                        return d.name
                    }))
                    .range([50, bar_width-50])
                    .paddingInner(0.25);

                var y = d3.scaleLinear()
                    .range([bar_height-50, 50])
                    .domain([0, maxVal]);

                    /* var colorScale = d3.scaleOrdinal().domain(x.domain())
                      .range(["#5FBDFB", "#EA3B66", "#F5D932",
                      "#083D77", "#EA2B1F", "#995D81", "#1D8A99", "#F3A712", "#136F63",
                      "#9368B7", "#9BC53D", "#122C34"]) */

                      var colorScale = d3.scaleOrdinal().domain(x.domain())
                      .range(["#7DCCFF"])

                    var barX = d3.scaleBand()
                    .domain(fundHist.map(function(d) {
                        return d.name
                    }))
                    .range([60, bar_width-120])
                    .padding(0.1);
                    
                    var barY = d3.scaleLinear()
                    .range([bar_height-50, 100])
                    .domain([0, maxVal])

                    var maxTicks = maxVal
                    if (maxVal > 30) {
                      maxTicks = maxVal / 2
                    }

                    barSVG.append("g")
                    .attr("transform", "translate(50,0)")
                    .call(d3.axisLeft(y).ticks(maxTicks).tickSize(-bar_width+100));

                    var bars = barSVG.selectAll(".bar")
                    .data(fundHist)
                    .enter().append("rect")
                    .attr("class", "bar")
                    .attr("fill", function(d) {
                      return colorScale(d.name)
                    })
                    .attr("x", function(d) { return x(d.name); })
                    .attr("width", x.bandwidth())
                    .attr("y", bar_height - 50)
                    .attr("height", 0)

                    bars.transition()
                    .duration(1500)
                    .attr("height", function(d) { return bar_height -50 - y(+d.startups); })
                    .attr("y", function(d) { return y(+d.startups); })

                      // add the x Axis
                    /* barSVG.append("g")
                        .attr("transform", "translate(0," + (bar_height - 50) + ")")
                        .call(d3.axisBottom(barX)); */

                    // add the y Axis
                    barSVG.append("g")
                    .attr("transform", "translate(0," + (bar_height-50) + ")")
                    .call(d3.axisBottom(x).ticks(fundHist.length));

                    barSVG.append("text")             
                      .attr("transform",
                        "translate(" + (bar_width/2) + " ," + 
                           (bar_height-50 + 26) + ")")
                    .attr("class", "bar-axis-label")
                    .text("Funding");

                    barSVG.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 12)
                    .attr("x",0 - ((bar_height-10) / 2))
                    .attr("dy", "1em")
                    .attr("class", "bar-axis-label")
                    .text("Number of Startups");   

                } 
                if (type === "Founded Year") {

                    var yearHist = []
                    var years = []
                    bar_data.forEach(function(v) {
                      if (years.indexOf(+v.Founded) < 0) {
                        var yearVal = +v.Founded
                        yearHist.push({'Year': yearVal, 'startups': 0})
                        years.push(+v.Founded)
                      } 
                    })

                    bar_data.forEach(function(v) {
                      yearHist.forEach(function(w) {
                        if (+v.Founded === w.Year) {
                          w.startups += 1
                        }
                      })
                    })
                    yearHist = yearHist.sort((a, b) => (a.Year > b.Year) ? 1 : -1)
                    //var parseDate = d3.timeParse("%Y");
                    /* var maxVal = d3.max(bar_data, function(d) {
                        return parseDate(d.Year)
                    })

                    var minVal = d3.min(bar_data, function(d) {
                        return parseDate(d.Year)
                    }) */

                    var maxVal = d3.max(yearHist, function(d) {
                      return d.startups
                  })

                  var x = d3.scaleBand()
                  .domain(yearHist.map(function(d) {
                      return d.Year
                  }))
                  .range([50, bar_width-50])
                  .paddingInner(0.25);

                  /*
                  var colorScale = d3.scaleOrdinal().domain(x.domain())
                  .range(["#5FBDFB", "#EA3B66", "#F5D932",
                  "#083D77", "#EA2B1F", "#995D81", "#1D8A99", "#F3A712", "#136F63",
                  "#9368B7", "#9BC53D", "#122C34"]) */

                  var colorScale = d3.scaleOrdinal().domain(x.domain())
                  .range(["#7DCCFF"])

                  var y = d3.scaleLinear()
                  .range([bar_height-50, 50])
                  .domain([0, maxVal]);

                  var maxTicks = maxVal
                  if (maxVal > 30) {
                    maxTicks = maxVal / 2
                  }

                  barSVG.append("g")
                  .attr("transform", "translate(50,0)")
                  .call(d3.axisLeft(y).ticks(maxTicks).tickSize(-bar_width+100));

                  var bars = barSVG.selectAll(".bar")
                  .data(yearHist)
                  .enter().append("rect")
                  .attr("class", "bar")
                  .attr("fill", function(d) {
                    return colorScale(d.Year)
                  })
                  .attr("x", function(d) { return x(d.Year); })
                  .attr("width", x.bandwidth())
                  .attr("y", bar_height - 50)
                  //.attr("height", function(d) { return bar_height -50 - y(+d.startups); });
                  .attr("height", 0)

                  bars.transition()
                    .duration(1500)
                    .attr("height", function(d) { return bar_height -50 - y(+d.startups); })
                    .attr("y", function(d) { return y(+d.startups); })



                  barSVG.append("g")
                  .attr("transform", "translate(0," + (bar_height-50) + ")")
                  .call(d3.axisBottom(x).ticks(yearHist.length));

                  barSVG.append("text")             
                  .attr("transform",
                    "translate(" + (bar_width/2) + " ," + 
                       (bar_height-50 + 26) + ")")
                .attr("class", "bar-axis-label")
                .text("Year Founded");

                barSVG.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 12)
                .attr("x",0 - ((bar_height-10) / 2))
                .attr("dy", "1em")
                .attr("class", "bar-axis-label")
                .text("Number of Startups");   

                    /* var x = d3.scaleTime()
                        .domain([minVal, maxVal])
                        .rangeRound([50, bar_width-50])

                    var y = d3.scaleLinear()
                        .range([bar_height-50, 50]);

                    var histogram = d3.histogram()
                        .value(function(d) { 
                            return parseDate(d.Year)})
                        .domain(x.domain())
                        .thresholds(x.ticks(d3.timeYear))

                        var bins = histogram(bar_data);

                        var maxLength = d3.max(bins, function(v) {
                            return v.length
                        })

                        if (bins.length > 20) {
                            xTicks = bins.length/2
                        } else {
                            xTicks = bins.length
                        }
                        

                        y.domain([0, d3.max(bins, function(d) { return d.length; })]);

                        barSVG.append("g")
                        .attr("transform", "translate(50,0)")
                        .call(d3.axisLeft(y).ticks(maxLength).tickSize(-bar_width));

                        barSVG.selectAll("rect")
                        .data(bins)
                      .enter().append("rect")
                        .attr("class", "bar")
                        .attr("x", 1)
                        .attr("transform", function(d, i) {
                            return "translate(" + x(d.x0) + "," + y(d.length) + ")"; })
                        .attr("width", function(d) { return x(d.x1) - x(d.x0)  ; })
                        .attr("height", function(d) { return bar_height-50 - y(d.length); })
                        .attr("fill", "#f1f1f1")

                        barSVG.append("g")
                        .attr("transform", "translate(0," + (bar_height-50) + ")")
                        .call(d3.axisBottom(x).ticks(xTicks));



                        barSVG.append("text")             
                        .attr("transform",
                          "translate(" + (bar_width/2) + " ," + 
                             (bar_height-50 + 26) + ")")
                      .attr("class", "bar-axis-label")
                      .text("Year");
  
                      barSVG.append("text")
                      .attr("transform", "rotate(-90)")
                      .attr("y", 12)
                      .attr("x",0 - ((bar_height-10) / 2))
                      .attr("dy", "1em")
                      .attr("class", "bar-axis-label")
                      .text("Number of Startups");  */

                    /* var barX = d3.scaleBand()
                    .domain(bar_data.map(function(d) {
                        return d["Startup"]
                    }))
                    .range([60, bar_width-120])
                    .padding(0.1);
                    
                    var barY = d3.scaleLinear()
                    .range([bar_height-50, 100])
                    .domain([minVal, maxVal])

                    barSVG.selectAll(".bar")
                    .data(bar_data)
                    .enter().append("rect")
                    .attr("class", "bar")
                    .attr("fill", "#f1f1f1")
                    .attr("stroke", "#36363c")
                    .attr("stroke-width", "2px")
                    .attr("x", function(d) { return barX(d["Startup"]); })
                    .attr("width", barX.bandwidth())
                    .attr("y", function(d) { return barY(+d.Year); })
                    .attr("height", function(d) { return bar_height -50 - barY(+d.Year); });

                      // add the x Axis
                    /* barSVG.append("g")
                        .attr("transform", "translate(0," + (bar_height - 50) + ")")
                        .call(d3.axisBottom(barX)); */
                    /* 
                    // add the y Axis
                    barSVG.append("g")
                    .attr("transform", "translate(" + 60 + ",0)")
                        .call(d3.axisLeft(barY)); */

                }

                  if (type === "Maturity") {
                  var maturityOrder = [
                  "Nascent", "Emerging", "Mature"]
                  function maturitySort(a, b) {
                    
                    for (i = 0; i < maturityOrder.length; i++) {
                      if (a === maturityOrder[i]) {
                        var valA = i;
                      }
                      if (b === maturityOrder[i]) {
                        var valB = i;
                      }
                    }
                    return valA < valB ? -1 : valA > valB ? 1 : valA >= valB ? 0 : NaN;
                  }

                  var maturity_data = d3.nest()
                  .key(function(d) {
                    return d["Maturity"]
                  })
                  .rollup(function(v) {
                    return {startups: v.length}
                  })
                  .sortKeys(maturitySort)
                  .entries(bar_data.filter(function(d) {
                    return d.Maturity != ""
                  }) )

                  

                  var maxVal = d3.max(maturity_data, function(d) {
                    return d.value.startups
                })

                var x = d3.scaleBand()
                .domain(maturity_data.map(function(d) {
                    return d.key
                }))
                .range([50, bar_width-50])
                .paddingInner(0.25);

                var colorScale = d3.scaleOrdinal().domain(x.domain())
                .range(["#7DCCFF"])

                var y = d3.scaleLinear()
                .range([bar_height-50, 50])
                .domain([0, maxVal]);

                var maxTicks = maxVal
                if (maxVal > 30) {
                  maxTicks = maxVal / 2
                }

                barSVG.append("g")
                .attr("transform", "translate(50,0)")
                .call(d3.axisLeft(y).ticks(maxTicks).tickSize(-bar_width+100));

                var bars = barSVG.selectAll(".bar")
                .data(maturity_data)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("fill", function(d) {
                  return colorScale(d.key)
                })
                .attr("x", function(d) { return x(d.key); })
                .attr("width", x.bandwidth())
                .attr("y", bar_height - 50)
                //.attr("height", function(d) { return bar_height -50 - y(+d.startups); });
                .attr("height", 0)

                bars.transition()
                .duration(1500)
                .attr("height", function(d) { return bar_height -50 - y(+d.value.startups); })
                .attr("y", function(d) { return y(+d.value.startups); })

                barSVG.append("g")
                .attr("transform", "translate(0," + (bar_height-50) + ")")
                .call(d3.axisBottom(x).ticks(maturity_data.length));

                barSVG.append("text")             
                .attr("transform",
                  "translate(" + (bar_width/2) + " ," + 
                     (bar_height-50 + 26) + ")")
              .attr("class", "bar-axis-label")
              .text("Maturity");

              barSVG.append("text")
              .attr("transform", "rotate(-90)")
              .attr("y", 12)
              .attr("x",0 - ((bar_height-10) / 2))
              .attr("dy", "1em")
              .attr("class", "bar-axis-label")
              .text("Number of Startups");   

                }




                
            }
  
            
            function switchRadial() {
              if (radial === "maturity") {
                radial = "year";
  
                nodes
                  .transition()
                  .duration(animationDuration)  
                  .attrTween("cx", function(d) {
                    var i = d3.interpolate(d.x, d.yearX);
                    return function(t) {
                      return i(t);
                    };
                  })
                  .attrTween("cy", function(d) {
                    var i = d3.interpolate(d.y, d.yearY);
                    return function(t) {
                      return i(t);
                    };
                  });
  
                nodes_activity
                  .transition()
                  .duration(animationDuration)
                  .attrTween("transform", function(d) {
                    var i = d3.interpolate(d.x - d.yearX, 0);
                    var j = d3.interpolate(d.y - d.yearY, 0);
                    return function(t) {
                      return "translate(" + i(t) + "," + j(t) + ")";
                    };
                  });
  
                nodes_acquired
                  .transition()
                  .duration(animationDuration)
                  .attrTween("transform", function(d) {
                    var i = d3.interpolate(d.x, d.yearX);
                    var j = d3.interpolate(d.y, d.yearY);
                    return function(t) {
                      return "translate(" + i(t) + "," + j(t) + ") rotate(45)";
                    };
                  });
  
                maturity_list.forEach(function(d) {
                  var id = "#" + d.name.toLowerCase() + "-label-path-text";
                  d3.select(id).remove();
                });
  
                count_by_year.forEach(function(d) {
                  d.fn
                    .append("text")
                    .attr("class", "year-label-text")
                    .attr("id", "year-" + d.key + "-label-path-text")
                    .append("textPath")
                    .attr("xlink:href", "#year-" + d.key + "-label-path")
                    .attr("startOffset", "50%")
                    .text(d.key);
  
                  chartPieData.forEach(function(v) {
                    d3.select(
                      "#year-" +
                        d.key +
                        "-" +
                        v.data.value.key.replace(/ /g, "-").replace(/&/g, "and").replace(/:/g, "") +
                        "-segment"
                    ).attr("opacity", 1);
                  });
                });
              } else {
                radial = "maturity";
  
                d3.select("#switch-button-year").style(
                  "background-color",
                  "#8e8e8e"
                );
                d3.select("#switch-button-maturity").style(
                  "background-color",
                  "#e74668"
                );
  
                nodes
                  .transition()
                  .duration(animationDuration)
                  .attrTween("cx", function(d) {
                    var i = d3.interpolate(d.yearX, d.x);
                    return function(t) {
                      return i(t);
                    };
                  })
                  .attrTween("cy", function(d) {
                    var i = d3.interpolate(d.yearY, d.y);
                    return function(t) {
                      return i(t);
                    };
                  });
  
                nodes_activity
                  .transition()
                  .duration(animationDuration)
                  .attrTween("transform", function(d) {
                    var i = d3.interpolate(0, d.x - d.yearX);
                    var j = d3.interpolate(0, d.y - d.yearY);
                    return function(t) {
                      return "translate(" + i(t) + "," + j(t) + ")";
                    };
                  });
  
                nodes_acquired
                  .transition()
                  .duration(animationDuration)
                  .attrTween("transform", function(d) {
                    var i = d3.interpolate(d.yearX, d.x);
                    var j = d3.interpolate(d.yearY, d.y);
                    return function(t) {
                      return "translate(" + i(t) + "," + j(t) + ") rotate(45)";
                    };
                  });
  
                count_by_year.forEach(function(d) {
                  var id = "#year-" + d.key + "-label-path-text";
                  d3.select(id).remove();
                  chartPieData.forEach(function(v) {
                    d3.select(
                      "#year-" +
                        d.key +
                        "-" +
                        v.data.value.key.replace(/ /g, "-").replace(/&/g, "and").replace(/:/g, "") +
                        "-segment"
                    ).attr("opacity", 0);
                  });
                });
  
                maturity_list_elements.forEach(function(d, i) {
                  d.fn
                    .append("text")
                    .attr("class", "maturity-label-text")
                    .attr("id", d.name.toLowerCase() + "-label-path-text")
                    .append("textPath")
                    .attr(
                      "xlink:href",
                      "#" + d.name.toLowerCase() + "-label-path"
                    )
                    .attr("startOffset", "50%")
                    .text(d.name);
                });
              }
            } 
  
            function dateForMode(data) {
              if (
                CompetitorMode === 0 ||
                data["Competitor Categor  y"] !== "Activity"
              ) {
                return data["Founded"];
              } else {
                return data["Activity/Acquisition Time"];
              }
            }
  
            function text_wrap(entry) {
              limit = 20;
              entryList = entry.split(/\s+/);
              lines = [];
              current_seq_len = 0;
              current_seq = [];
              for (i = 0; i < entryList.length; i++) {
                current_seq_len += entryList[i].length;
                current_seq.push(entryList[i].replace(/�۪/g, "'"));
                if (current_seq_len > limit) {
                  lines.push(current_seq);
                  current_seq_len = 0;
                  current_seq = [];
                }
              }
              lines.push(current_seq);
              results = "";
              x = 0;
              for (i = 0; i < lines.length; i++) {
                tmp = "";
                for (j = 0; j < lines[i].length; j++) {
                  if (j !== lines[i].length - 1) {
                    tmp += lines[i][j] + " ";
                  } else {
                    tmp += lines[i][j];
                  }
                }
                results +=
                  "<tspan x=" +
                  x +
                  " dy='1.1em' class='funding-hover-info'>" +
                  tmp +
                  "</tspan>";
              }
              return results;
            }
  
  
            function labelMouseOver(segment_data) {
              var count_by_focus_area = d3
                .nest()
                .key(function(d) {
                  return d["Primary SDG"];
                })
              .sortKeys(function(a, b) {
                let aVal = 0
                let bVal = 0
                focusAreaSort.forEach(function(v, index) {
                  if (a === v) {
                    aVal = index
                  }
                  if (b === v) {
                    bVal = index
                  }
                })
                return d3.ascending(aVal, bVal)
              })
                .entries(
                  data.filter(function(d) {
                    if (clientFilter !== "All Startups") {
                      return d["Client Served"] === clientFilter;
                    } else {
                      return d;
                    }
                  })
                );
  
              nodes.attr("opacity", function(d) {
                if (d["Primary SDG"] === segment_data.data.value.key) {
                  return 1;
                } else {
                  return 0.3;
                }
              });
  
              nodes_acquired.attr("opacity", function(d) {
                if (d["Primary SDG"] === segment_data.data.value.key) {
                  return 1;
                } else {
                  return 0.3;
                }
              });
            }
  
            function labelMouseOut() {
              //d3.select("#label-mouse-over-text").remove();
              //d3.select("#hover-svg-background").remove();
               d3.select("#opp-space-tooltip-container").style("display", "none")
              segmentsLabelBand.attr("opacity", function(d) {
                return d.opacity;
              });
              nodes.attr("opacity", function(d) {
                return d.opacity;
              });
              nodes_acquired.attr("opacity", function(d) {
                return d.opacity;
              });
            }
  
            function keyMouseOver(data, type) {
              if (type === "acquired") {
                nodes_acquired.attr("opacity", 1);
                nodes.attr("opacity", 0.3);
                nodes_activity.attr("opacity", 0.3);
              }
              /* if (type === "size") {
                  nodes.attr("opacity", function(d) {
                    if (nodeSizeScaleFunction(d["Funding amount ($)"]) === data) {
                      return 1;
                    } else {
                      return 0.3;
                    }
                  });
                  nodes_acquired.attr("opacity", 0.3);
                } */
              if (type === "color") {
                nodes.attr("opacity", function(d) {
                  if (fundingCategoryScale(d["Funding Round"]) === data) {
                    return 1;
                  } else {
                    return 0.3;
                  }
                });
                nodes_acquired.attr("opacity", 0.3);
                nodes_activity.attr("opacity", 0.3);
              }
  
              if (type === "activity") {
                nodes.attr("opacity", function(d) {
                  if (d["Activity/Acquisition Time"] != "" && d.hide === false) {
                    return 1;
                  } else {
                    return 0.3;
                  }
                });
  
                nodes_activity.attr("opacity", function(d) {
                  if (d["Activity/Acquisition Time"] != "") {
                    return 1;
                  } else {
                    return 0.3;
                  }
                });
  
                nodes_acquired.attr("opacity", function(d) {
                  if (d["Activity/Acquisition Time"] != "" && d.hide === false) {
                    return 1;
                  } else {
                    return 0.3;
                  }
                });
              }
            }
  
            function keyMouseOut() {
              nodes.attr("opacity", function(d) {
                return d.opacity;
              });
              nodes_acquired.attr("opacity", function(d) {
                return d.opacity;
              });
            }

            function showOppSpaceTooltip(segment_data, clicked = "") {              
              /*desc.forEach(function(v) {
                if (
                  segment_data.data.value.key ===
                  v["Primary SDG"].toLowerCase().replace(/\//g, "_")
                ) {
                  segmentDesc = v.Description;
                }
              });*/
            var count_by_focus_area = d3
              .nest()
              .key(function(d) {
                return d["Primary SDG"];
              })
              .sortKeys(function(a, b) {
                let aVal = 0
                let bVal = 0
                focusAreaSort.forEach(function(v, index) {
                  if (a === v) {
                    aVal = index
                  }
                  if (b === v) {
                    bVal = index
                  }
                })
                return d3.ascending(aVal, bVal)
              })
              .entries(data.filter(function(v) {
                if (filters.type === "All Startups") {
                  return v
                } else {
                  return v["Client Served"] === filters.type
                }
              }).filter(function(v) {
                if (filters.geotype === "All Startups") {
                  return v
                } else {
                  return v["Global"] === filters.geotype
                }
              }));

              var numberOfStartups = 0;
              var segmentFunding = 0;
              for (i = 0; i < count_by_focus_area.length; i++) {
                if (
                  count_by_focus_area[i].key === segment_data.data.value.key
                ) {
                  numberOfStartups = count_by_focus_area[i].values.length;
                  theme = count_by_focus_area[i].values[0]["Theme"];
                  themeDesc =
                    count_by_focus_area[i].values[0]["Theme Definition"];
                  segmentFunding = d3.sum(
                    count_by_focus_area[i].values,
                    function(d) {
                      return d["Funding amount ($)"];
                    }
                  );
                }
              }
              if (numberOfStartups === 0) {
                  var avgFunding = 0;
                } else {
                  var avgFunding = segmentFunding / numberOfStartups;
                }
              d3.select("#opp-space-tooltip-container").style("display", "block")
              d3.select(".opp-space-tooltip-title").text((segment_data.data.value.key).toUpperCase().replace(/_/g, "/"))
              //d3.select("#ostt-1").text(segmentDesc)
              d3.select("#ostt-3").text(formatFunding(segmentFunding))
              d3.select("#ostt-5").text(numberOfStartups)
              d3.select("#ostt-7").text(formatFunding(avgFunding))
              //d3.select("#ostt-8").text(theme.toUpperCase())
              //d3.select("#ostt-9").text(themeDesc)
            }

            function formatURL(url) {
              if (url.slice(0,3) === "www") {
                return "http://" + url
              } else {
                return url
              }
            }

            function showNodeTooltip(d) {              
              const fundingList = ["Unfunded"]
              let fundingVal = 0
              if (fundingList.indexOf(d["Funding Round"]) < 0) {
                if (d["Funding amount ($)"] == 0) {
                  fundingVal = "Undisclosed"
                } else {
                  fundingVal = "$" + formatFunding(d["Funding amount ($)"])
                }
              } else {
                fundingVal = "$" + formatFunding(d["Funding amount ($)"])
              }

              d3.select(".node-tooltip-title").text(d["Startup Name"]);
              d3.select(".node-tooltip-funding").text("Total Funding: " + (fundingVal));
              d3.select(".node-tooltip-description").text(d["Impact Statement"].replace(/�۪/g, "'"));

              d3.select(".node-tooltip")
              .style("opacity", 1);

              const { width, height } =  d3.select(".node-tooltip").node().getBoundingClientRect();

              let padding = 10;
              let x = d3.event.clientX;
              if (x + padding + width > window.innerWidth) {
                x = x - padding - width;
              } else {
                x = x + padding;
              }
              let y = d3.event.clientY;
              if (y + padding + height > window.innerHeight) {
                y = y - padding - height;
              } else {
                y = y + padding;
              }

              nodes.attr("opacity", function(v) {
                if (v["Funding Round"] === d["Funding Round"]) {
                  return 1;
                } else {
                  return 0.3;
                }
              });
              if (d["Funding Round"] === "Acquired") {
                nodes_acquired.attr("opacity", 1);
              } else {
                nodes_acquired.attr("opacity", 0.3);
              }

              d3.select(".node-tooltip").style("transform", `translate(${x}px,${y}px)`);
            }

            function hideNodeTooltip() {
              d3.select(".node-tooltip")
              .style("opacity", 0);
              nodes.attr("opacity", function(d) {
                return d.opacity;
              });
              nodes_acquired.attr("opacity", function(d) {
                return d.opacity;
              });
            }
  
            function nodeMouseOver(data) {
              if (radial === "maturity") {
                var nodeX = data.x;
                var nodeY = data.y;
              } else {
                var nodeX = data.yearX;
                var nodeY = data.yearY;
              }
  
              var dummyHoverText = chartSVG
                .append("text")
                .attr("id", "node-mouse-over-dummy-text")
                .attr("class", "node-mouse-over-text")
                .attr("x", function() {
                  return nodeX;
                })
                .attr("y", function() {
                  return nodeY;
                })
                .attr("dy", function() {
                  return "-0.75em";
                })
                .attr("fill-opacity", 0)
                .html(function() {
                  var x = d3.select(this).attr("x");
                  return hover_info(
                    data["Impact Statement"],
                    data["Startup Name"],
                    dateForMode(data),
                    data["Funding amount ($)"],
                    x
                  );
                });
  
              var toolBox = chartSVG
                .append("rect")
                .attr("id", "node-mouse-over-box")
                .attr("x", function() {
                  var x =
                    nodeX -
                    dummyHoverText.node().getBoundingClientRect().width / 2 -
                    8;
                  if (x < -400) {
                    return -400;
                  } else {
                    return x;
                  }
                })
                .attr("y", function() {
                  return (
                    nodeY -
                    dummyHoverText.node().getBoundingClientRect().height -
                    26
                  );
                })
                .attr("width", function() {
                  return dummyHoverText.node().getBoundingClientRect().width + 16;
                })
                .attr(
                  "height",
                  dummyHoverText.node().getBoundingClientRect().height + 22
                )
                .style("fill", "white")
                .attr("fill-opacity", 0.9);
  
              var hoverText = chartSVG
                .append("text")
                .attr("id", "node-mouse-over-actual-text")
                .attr("class", "node-mouse-over-text")
                .attr("x", function() {
                  var x =
                    nodeX -
                    dummyHoverText.node().getBoundingClientRect().width / 2;
                  if (x < -400) {
                    return -392;
                  } else {
                    return x;
                  }
                })
                .attr("y", function() {
                  return (
                    nodeY -
                    dummyHoverText.node().getBoundingClientRect().height -
                    10
                  );
                })
                .attr("dy", function() {
                  return "-0.75em";
                })
                .attr("fill-opacity", 1)
                .html(function() {
                  var x = d3.select(this).attr("x");
                  return hover_info(
                    data["Impact Statement"],
                    data["Startup Name"],
                    dateForMode(data),
                    data["Funding amount ($)"],
                    x
                  );
                });
  
              nodes.attr("opacity", function(d) {
                if (d["Funding Round"] === data["Funding Round"]) {
                  return 1;
                } else {
                  return 0.3;
                }
              });
              if (data["Funding Round"] === "Acquired") {
                nodes_acquired.attr("opacity", 1);
              } else {
                nodes_acquired.attr("opacity", 0.3);
              }
            }
  
            function nodeMouseOut() {
              d3.select("#node-mouse-over-dummy-text").remove();
              d3.select("#node-mouse-over-box").remove();
              d3.select("#node-mouse-over-actual-text").remove();
  
              nodes.attr("opacity", function(d) {
                return d.opacity;
              });
              nodes_acquired.attr("opacity", function(d) {
                return d.opacity;
              });
            }
            function save_split() {
              for (let i = 0; i < chartPieData.length; i++) {
                setTimeout(function() {
                  var selection =
                    "#background-segment-" +
                    chartPieData[i].data.value.key
                      .replace(/ /g, "-")
                      .replace(/&/g, "and").replace(/:/g, "")
                  var tmp_width =
                    d3
                      .select(selection)
                      .node()
                      .getBoundingClientRect().width + 40;
                  var tmp_height =
                    d3
                      .select(selection)
                      .node()
                      .getBoundingClientRect().height + 40;
  
                  var tmp_svg = d3
                    .select("#tmp-container")
                    .append("svg")
                    .attr("width", tmp_width)
                    .attr("height", tmp_height);
  
                          if (i === 0) {
                            var hor = tmp_width - 170
                            var ver = tmp_height + 45;
                          }
                          if (i === 1) {
                            var hor = tmp_width - 290;
                            var ver = tmp_height + 20;
                          }
                          if (i === 2) {
                            var hor = tmp_width - 340;
                            var ver = tmp_height - 20;
                          }
                          if (i === 3) {
                            var hor = tmp_width - 335;
                            var ver = tmp_height - 170;
                          }
                          if (i === 4) {
                            var hor = tmp_width - 290;
                            var ver = tmp_height - 290;
                          }
                          if (i === 5) {
                            var hor = tmp_width - 180;
                            var ver = tmp_height - 330;
                          }
                          if (i === 6) {
                            var hor = tmp_width - 15;
                            var ver = tmp_height - 330;
                          }
                          if (i === 7) {
                            var hor = tmp_width + 20;
                            var ver = tmp_height - 290;
                          }
                          if (i === 8) {
                            var hor = tmp_width + 40;
                            var ver = tmp_height - 180;
                          }
                          if (i === 9) {
                         var hor = tmp_width + 40;
                            var ver = tmp_height - 10;
                          }
                          if (i === 10) {
                            var hor = tmp_width + 25;
                            var ver = tmp_height + 25;
                          }
                          if (i === 11) {
                            var hor = tmp_width - 15;
                            var ver = tmp_height + 45;
                          }
  
                  var tmp_chartSVG = tmp_svg
                    .append("g")
                    .attr("transform", "translate(" + hor + "," + ver + ")");
  
                  if (radial === "maturity") {
                    var tmp_nascentSegments = tmp_chartSVG
                      .selectAll("nascent-segments")
                      .data([chartPieData[i]])
                      .enter()
                      .append("path")
                      .style("fill-opacity", 1)
                      .attr("class", function(d) {
                        return (
                          "nascent-segments segment-" +
                          d.data.value.key.replace(/ /g, "-").replace(/&/g, "and").replace(/:/g, "")
                        );
                      })
                      .attr("id", function(d) {
                        return (
                          "tmp-nascent-segment-" +
                          d.data.value.key.replace(/ /g, "-").replace(/&/g, "and").replace(/:/g, "")
                        );
                      })
                      .style("stroke", "white")
                      .style("stroke-width", "2px")
                      .attr("fill", "#DFDFDF") //F4F4F4
                      .attr("d", nascentArc);
  
                    var tmp_emergingSegments = tmp_chartSVG
                      .selectAll("emerging-segments")
                      .data([chartPieData[i]])
                      .enter()
                      .append("path")
                      .style("fill-opacity", 1)
                      .attr("class", function(d) {
                        return (
                          "emerging-segments segment-" +
                          d.data.value.key.replace(/ /g, "-").replace(/&/g, "and").replace(/:/g, "")
                        );
                      })
                      .attr("id", function(d) {
                        return (
                          "tmp-emerging-segment-" +
                          d.data.value.key.replace(/ /g, "-").replace(/&/g, "and").replace(/:/g, "")
                        );
                      })
                      .style("stroke", "white")
                      .style("stroke-width", "2px")
                      .attr("fill", "#E9E9E9")
                      .attr("d", emergingArc);
  
                    var tmp_matureSegments = tmp_chartSVG
                      .selectAll("mature-segments")
                      .data([chartPieData[i]])
                      .enter()
                      .append("path")
                      .style("fill-opacity", 1)
                      .attr("class", function(d) {
                        return (
                          "mature-segments segment-" +
                          d.data.value.key.replace(/ /g, "-").replace(/&/g, "and").replace(/:/g, "")
                        );
                      })
                      .attr("id", function(d) {
                        return (
                          "tmp-mature-segment-" +
                          d.data.value.key.replace(/ /g, "-").replace(/&/g, "and").replace(/:/g, "")
                        );
                      })
                      .style("stroke", "white")
                      .style("stroke-width", "2px")
                      .attr("fill", "#F4F4F4") //DFDFDF
                      .attr("d", matureArc);
                  } else {
                    count_by_year.forEach(function(v) {
                      var tmpArc = d3
                        .arc()
                        .innerRadius(v.inner)
                        .outerRadius(v.outer);
  
                      var tmpSegment = tmp_chartSVG
                        .selectAll("year-segment")
                        .data([chartPieData[i]])
                        .enter()
                        .append("path")
                        .attr("class", "segment")
                        .attr("d", tmpArc)
                        .attr("fill", "#f4f4f4");
                    });
                  }
  
                  var tmpSegmentsLabelBand = tmp_chartSVG
                    .selectAll("path.segment-band")
                    .data([chartPieData[i]])
                    .enter()
                    .append("path")
                    .classed("segment-band", true)
                    .attr("d", segmentLabelBandArc)
                    .attr("fill", "#7DCCFF")
  
                  var tmpLabels = tmp_chartSVG
                    .append("g")
                    .classed("labels", true);
                  var tmpLabelsOther = tmp_chartSVG
                    .append("g")
                    .classed("labels", true);
  
                  tmpLabels
                    .append("def")
                    .append("path")
                    .attr("id", "label-path")
                    .attr(
                      "d",
                      "m0 " +
                        -labelRadius +
                        " a" +
                        labelRadius +
                        " " +
                        labelRadius +
                        " 0 1,1 -0.01 0"
                    );
  
                  tmpLabelsOther
                    .append("def")
                    .append("path")
                    .attr("id", "label-other-path")
                    .attr(
                      "d",
                      "m0 " +
                        -labelOtherRadius +
                        " a" +
                        labelOtherRadius +
                        " " +
                        labelOtherRadius +
                        " 0 1,1 -0.01 0"
                    );
  
                  tmpLabels
                    .selectAll("text")
                    .data([chartPieData[i]])
                    .enter()
                    .append("text")
                    .attr("class", "label-text")
                    .append("textPath")
                    .attr("xlink:href", "#label-path")
                    .attr("startOffset", function(d, i) {
                      var percentage =
                        ((d.endAngle - d.startAngle) / 2 + d.startAngle) /
                        0.0628319;
                      return percentage + "%";
                    })
                    .text(function(d) {
                      return label_wrap(d.data.value.key.toUpperCase())[0];
                    });
  
                  tmpLabelsOther
                    .selectAll("text")
                    .data([chartPieData[i]])
                    .enter()
                    .append("text")
                    .attr("class", "label-text")
                    .append("textPath")
                    .attr("xlink:href", "#label-other-path")
                    .attr("startOffset", function(d, i) {
                      var percentage =
                        ((d.endAngle - d.startAngle) / 2 + d.startAngle) /
                        0.0628319;
                      return percentage + "%";
                    })
                    .text(function(d) {
                      var result = label_wrap(d.data.value.key.toUpperCase());
                      if (result.length > 2) {
                        return result[1] + " " + result[2];
                      } else {
                        return result[1];
                      }
                    });
  
                  var tmp_nodes = tmp_chartSVG
                    .selectAll("nodes")
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("class", "nodes")
                    .attr("r", function(d) {
                      if (d["Funding Round"] !== "Acquired") {
                        return nodeRadius;
                      }
                    })
                    .attr("opacity", function(d) {
                      return d.opacity;
                    })
                    .attr("fill", function(d) {
                      return nodeColorScale(
                        fundingCategoryScale(d["Funding Round"])
                      );
                    })
                    .attr("cx", function(d) {
                      if (radial === "maturity") {
                        return d.x;
                      } else {
                        return d.yearX;
                      }
                    })
                    .attr("cy", function(d) {
                      if (radial === "maturity") {
                        return d.y;
                      } else {
                        return d.yearY;
                      }
                    })
                    .attr("opacity", function(d) {
                      if (
                        d["Primary SDG"] === chartPieData[i].data.value.key
                      ) {
                        return d.opacity;
                      } else {
                        return 0;
                      }
                    });
  
                  var tmp_acquired = tmp_chartSVG
                    .selectAll("nodes-acquired")
                    .data(data)
                    .enter()
                    .append("rect")
                    .attr("class", "nodes nodes-acquired")
                    .attr("opacity", function(d) {
                      return d.opacity;
                    })
                    .attr("opacity", function(d) {
                      return d.opacity;
                    })
                    .attr("width", function(d) {
                      if (d["Funding Round"] === "Acquired") {
                        return nodeOtherWidth
                      } else {
                        return 0;
                      }
                    })
                    .attr("height", function(d) {
                      if (d["Funding Round"] === "Acquired") {
                        return nodeOtherWidth
                      } else {
                        return 0;
                      }
                    })
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("fill", "#FFFD82")
                    .attr("transform", function(d) {
                      if (radial === "maturity") {
                        var x = d.x;
                        var y = d.y;
                      } else {
                        var x = d.yearX;
                        var y = d.yearY;
                      }
                      return "translate(" + x + "," + y + ")    rotate(45)";
                    })
                    .attr("opacity", function(d) {
                      if (
                        d["Primary SDG"] === chartPieData[i].data.value.key
                      ) {
                        return d.opacity;
                      } else {
                        return 0;
                      }
                    });
  
                  var name = chartPieData[i].data.value.key;
  
                  var svgString = getSVGString(tmp_svg.node());
  
                  svgString2Image(
                    svgString,
                    tmp_width * 2,
                    tmp_height * 2,
                    "png",
                    name,
                    save
                  );
  
                  function save(dataBlob, filesize, name) {
                    saveAs(dataBlob, "radar " + name + ".png");
                  }
  
                  tmp_svg.remove();
                }, 500 * i);
              }
            }
  
            function toggle_map(type) {
                if (type === "on") {
                    d3.select(".map-container").style("display", "")
                    d3.select(".map-tooltip").style("display", "none");
                    d3.select("#chart-container").style("display", "none")
                    d3.select("#key-container").style("display", "none")
                    d3.select("#control-container").style("display", "none")
                    d3.select("#hover-info-container").style("display", "none")
                    d3.select("#save-button-container").style("display", "none")
                     map.invalidateSize()
                } else {
                  d3.select(".map-container").style("display", "none")
                  d3.select(".map-tooltip").style("display", "none");
                    d3.select("#chart-container").style("display", "")
                    d3.select("#key-container").style("display", "")
                    d3.select("#control-container").style("display", "")
                    d3.select("#hover-info-container").style("display", "")
                    d3.select("#save-button-container").style("display", "")
                }
            }

            d3.select(".popup-close").on("click",  function() {
                d3.select(".popup-container").attr("class", "popup-container")
                d3.select(".popup-bg").style("display", "none")
                d3.select(".svg-bar-container").html("")
            })
  
            d3.select("#map-toggle-btn").on("click", function() {
                d3.select("#map-toggle-btn").attr("class", "left-sidebar-btn active")
                d3.select("#radar-toggle-btn").attr("class", "left-sidebar-btn")
                d3.select("body").style("background-color", "#F4F4F4")
               
              toggle_map("on")
            })
  
            // Set-up the export button
            d3.select("#save-button").on("click", function() {
              save_split();
  
              var svgString = getSVGString(svg.node());
              var name = "";
  
              svgString2Image(
                svgString,
                width * 2,
                height * 2,
                "png",
                name,
                save
              );
  
              function save(dataBlob, filesize, name) {
                saveAs(dataBlob, "radar.png");
              }
              // passes Blob and filesize String to the callback
            });
  
            // Below are the functions that handle actual exporting:
            // getSVGString ( svgNode ) and svgString2Image( svgString, width, height, format, callback )
            function getSVGString(svgNode) {
              svgNode.setAttribute("xlink", "http://www.w3.org/1999/xlink");
              var cssStyleText = getCSSStyles(svgNode);
              appendCSS(cssStyleText, svgNode);
  
              var serializer = new XMLSerializer();
              var svgString = serializer.serializeToString(svgNode);
              svgString = svgString.replace(/(\w+)?:?xlink=/g, "xmlns:xlink=");
              svgString = svgString.replace(/NS\d+:href/g, "xlink:href");
              svgString = svgString.replace(/"Graphik Regular";/g, "arial;");
              svgString = svgString.replace(/"Graphik Bold";/g, "arial;");
  
              return svgString;
  
              function getCSSStyles(parentElement) {
                var selectorTextArr = [];
  
                // Add Parent element Id and Classes to the list
                selectorTextArr.push("#" + parentElement.id);
                for (var c = 0; c < parentElement.classList.length; c++)
                  if (
                    !contains("." + parentElement.classList[c], selectorTextArr)
                  )
                    selectorTextArr.push("." + parentElement.classList[c]);
  
                // Add Children element Ids and Classes to the list
                var nodes = parentElement.getElementsByTagName("*");
                for (var i = 0; i < nodes.length; i++) {
                  var id = nodes[i].id;
  
                  if (!contains("#" + id, selectorTextArr))
                    selectorTextArr.push("#" + id);
  
                  var classes = nodes[i].classList;
                  for (var c = 0; c < classes.length; c++)
                    if (!contains("." + classes[c], selectorTextArr))
                      selectorTextArr.push("." + classes[c]);
                }
                // Extract CSS Rules
                var extractedCSSText = "";
                for (var i = 0; i < document.styleSheets.length; i++) {
                  var s = document.styleSheets[i];
  
                  try {
                    if (!s.cssRules) continue;
                  } catch (e) {
                    if (e.name !== "SecurityError") throw e;
                    continue;
                  }
  
                  var cssRules = s.cssRules;
  
                  //manually add css rules:
                  selectorTextArr.push("textPath");
  
                  for (var r = 0; r < cssRules.length; r++) {
                    if (contains(cssRules[r].selectorText, selectorTextArr))
                      extractedCSSText += cssRules[r].cssText;
                  }
                }
  
                return extractedCSSText;
  
                function contains(str, arr) {
                  return arr.indexOf(str) === -1 ? false : true;
                }
              }
  
              function appendCSS(cssText, element) {
                var styleElement = document.createElement("style");
                styleElement.setAttribute("type", "text/css");
                styleElement.innerHTML = cssText;
                var refNode = element.hasChildNodes()
                  ? element.children[0]
                  : null;
                element.insertBefore(styleElement, refNode);
              }
            }
          //});
          //});
        })
        });
  
        function round_to_precision(x, precision) {
          var y = +x + (precision === undefined ? 0.5 : precision / 2);
          return y - (y % (precision === undefined ? 1 : +precision));
        }
  
        const capitalize_word = s => {
          if (typeof s !== "string") return "";
          return s.charAt(0).toUpperCase() + s.slice(1);
        };
  
        function capitalize_sentence(string) {
          var res = string.split(" ");
          result_list = [];
          for (i = 0; i < res.length; i++) {
            result_list.push(capitalize_word(res[i]));
          }
          return result_list.join(" ");
        }
  
        function formatFunding(total_funding) {
          fundingFormatted = total_funding;
          if (fundingFormatted != 0 ) {
            if (typeof fundingFormatted == "string") {
              if (fundingFormatted.slice(0,1) === '$') {
                fundingFormatted = fundingFormatted.slice(1)
              }
            }
          }
          if (total_funding <= 900000 && total_funding > 1000) {
            fundingFormatted = Math.round(total_funding / 10) / 100 + "K";
          }
          if (total_funding > 900000) {
            fundingFormatted = Math.round(total_funding / 10000) / 100 + "M";
          }
          return fundingFormatted;
        }
  
        function hover_info(
          text_data,
          text_title,
          funding_year,
          total_funding,
          x,
          limit = 35
        ) {
          fundingFormatted = formatFunding(total_funding);
  
          words = text_data.split(/\s+/);
          lines = [];
          current_seq_len = 0;
          current_seq = [];
          result =
            "<tspan x=" +
            x +
            " dy='0em' class='wrap-header'>" +
            text_title +
            "</tspan>" +
            "<tspan x=" +
            x +
            " dy='1.1em' class='wrap-year'>Founded: " +
            funding_year +
            "</tspan>" +
            "<tspan x=" +
            x +
            " dy='1.1em' class='wrap-year'>Total Funding: $" +
            fundingFormatted +
            "</tspan>";
          for (i = 0; i < words.length; i++) {
            current_seq_len += words[i].length;
            current_seq.push(words[i].replace(/�۪/g, "'"));
            if (current_seq_len > limit) {
              lines.push(current_seq);
              current_seq_len = 0;
              current_seq = [];
            }
          }
          lines.push(current_seq);
          for (i = 0; i < lines.length; i++) {
            tmp = "";
            for (j = 0; j < lines[i].length; j++) {
              if (j !== lines[i].length - 1) {
                tmp += lines[i][j] + " ";
              } else {
                tmp += lines[i][j];
              }
            }
            result += "<tspan x=" + x + " dy='1.1em'>" + tmp + "</tspan>";
          }
          return result;
        }
  
        function label_wrap(text_data, limit = 7) {
          words = text_data.split(/\s+/);
          lines = [];
          current_seq_len = 0;
          current_seq = [];
          result = [];
          for (i = 0; i < words.length; i++) {
            current_seq_len += words[i].length;
            current_seq.push(words[i].replace(/�۪/g, "'"));
            if (current_seq_len > limit) {
              lines.push(current_seq);
              current_seq_len = 0;
              current_seq = [];
            }
          }
          lines.push(current_seq);
          for (i = 0; i < lines.length; i++) {
            tmp = "";
            for (j = 0; j < lines[i].length; j++) {
              if (j !== lines[i].length - 1) {
                tmp += lines[i][j] + " ";
              } else {
                tmp += lines[i][j];
              }
            }
            var dx = -tmp.length + "em";
            result.push(tmp);
          }
          return result;
        }
  
        function svgString2Image(
          svgString,
          width,
          height,
          format,
          name,
          callback
        ) {
          var format = format ? format : "png";
  
          var imgsrc =
            "data:image/svg+xml;base64," +
            btoa(unescape(encodeURIComponent(svgString)));
  
          var canvas = document.createElement("canvas");
          var context = canvas.getContext("2d");
  
          canvas.width = width;
          canvas.height = height;
  
          var image = new Image();
          image.onload = function() {
            context.clearRect(0, 0, width, height);
            context.drawImage(image, 0, 0, width, height);
  
            canvas.toBlob(function(blob) {
              var filesize = Math.round(blob.length / 1024) + " KB";
              if (callback) callback(blob, filesize, name);
            });
          };
  
          image.src = imgsrc;
        }

        function calcCongestion(
          tmp_startAngleMin,
          tmp_endAngleMax,
          tmp_innerRadiusMin,
          tmp_outerRadiusMax,
          radiusSize=2,
          numNodes
        ) {
          // calculate area of arc
          var areaA = Math.PI * (tmp_outerRadiusMax**2) * (tmp_endAngleMax - tmp_startAngleMin) / 6.28319
          var areaB = Math.PI * (tmp_innerRadiusMin**2) * (tmp_endAngleMax - tmp_startAngleMin) / 6.28319
          var area = areaA - areaB
          
          // divide by area of circle * numNodes
          var areaNode = Math.PI * (radiusSize**2)

          // High is lots of space, low is less space.
          return area / (areaNode * numNodes) 
        }

        function assignNonRandomYear(
          data,
          tmp_startAngleMin,
          tmp_endAngleMax,
          tmp_innerRadiusMin,
          tmp_outerRadiusMax,
          nodeDataEntry
        ) {
            var numNodes = nodeDataEntry.value
            var horizontalCuts = numNodes/2
            var verticalCuts = 2
            var totalSpots = numNodes

          vertDivision = (tmp_outerRadiusMax - tmp_innerRadiusMin) / verticalCuts
          horDivision = (tmp_endAngleMax - tmp_startAngleMin) / horizontalCuts

          horizontalSlot = 0
          verticalSlot = 0
          index = 0
          loop0:
          for (let vi = 0; vi <= verticalCuts; vi++) {
            loop1:
            for (let hi = 0; hi <= horizontalCuts; hi++) {
              index ++
            if (index === indexTrackerYear[data["Primary SDG"]][data["Founded"]]["slot"]) {
              horizontalSlot = hi
              verticalSlot = vi
              break loop0
            }  
            }
          }
          tmp_innerRadius = tmp_innerRadiusMin + verticalSlot * vertDivision
          tmp_outerRadius = tmp_innerRadius + vertDivision
          tmp_startAngle = tmp_startAngleMin + horizontalSlot * horDivision
          tmp_endAngle = tmp_startAngle + horDivision

          tmp_gen = d3
            .arc()
            .innerRadius(tmp_innerRadius)
            .outerRadius(tmp_outerRadius)
            .startAngle(tmp_startAngle)
            .endAngle(tmp_endAngle);

          tmp_x = tmp_gen.centroid()[0];
          tmp_y = tmp_gen.centroid()[1];

          return [tmp_x, tmp_y];
        }

        function assignNonRandom(
          data,
          tmp_startAngleMin,
          tmp_endAngleMax,
          tmp_innerRadiusMin,
          tmp_outerRadiusMax,
          nodeDataEntry) {
            // divide space into a grid?
            // half till ~number of nodes?
            var numNodes = nodeDataEntry.value
            var horizontalCuts = 0
            var verticalCuts = 0
                 
            for (let o = 0; o < numNodes; o++) {
              if (o % 2 == 0) {
                horizontalCuts++
              } else {
                verticalCuts++
              }
              var totalSpots = horizontalCuts * verticalCuts
              if (totalSpots > numNodes) {
                break;
              }
            }

          vertDivision = (tmp_outerRadiusMax - tmp_innerRadiusMin) / verticalCuts
          horDivision = (tmp_endAngleMax - tmp_startAngleMin) / horizontalCuts

          horizontalSlot = 0
          verticalSlot = 0
          index = 0
          loop0:
          for (let vi = 0; vi <= verticalCuts; vi++) {
            loop1:
            for (let hi = 0; hi <= horizontalCuts; hi++) {
              index ++
            if (index === indexTracker[data["Primary SDG"]][data["Maturity"]]["slot"]) {
              horizontalSlot = hi
              verticalSlot = vi
              break loop0
            }
            
            }
          }

          tmp_innerRadius = tmp_innerRadiusMin + verticalSlot * vertDivision
          tmp_outerRadius = tmp_innerRadius + vertDivision
          tmp_startAngle = tmp_startAngleMin + horizontalSlot * horDivision
          tmp_endAngle = tmp_startAngle + horDivision

          tmp_gen = d3
            .arc()
            .innerRadius(tmp_innerRadius)
            .outerRadius(tmp_outerRadius)
            .startAngle(tmp_startAngle)
            .endAngle(tmp_endAngle);

          tmp_x = tmp_gen.centroid()[0];
          tmp_y = tmp_gen.centroid()[1];

          return [tmp_x, tmp_y];

          }
  
        function assignRandom(
          tmp_startAngleMin,
          tmp_endAngleMax,
          tmp_innerRadiusMin,
          tmp_outerRadiusMax,
          congestion,
          nodeList
        ) {
          tmp_startAngle =
            Math.random() * (tmp_endAngleMax - tmp_startAngleMin) +
            tmp_startAngleMin;
          tmp_endAngle =
            Math.random() * (tmp_endAngleMax - tmp_startAngle) + tmp_startAngle;
          tmp_innerRadius =
            Math.random() * (tmp_outerRadiusMax - tmp_innerRadiusMin) +
            tmp_innerRadiusMin;
          tmp_outerRadius =
            Math.random() * (tmp_outerRadiusMax - tmp_innerRadius) +
            tmp_innerRadius;
          tmp_gen = d3
            .arc()
            .innerRadius(tmp_innerRadius)
            .outerRadius(tmp_outerRadius)
            .startAngle(tmp_startAngle)
            .endAngle(tmp_endAngle );
  
          tmp_x = tmp_gen.centroid()[0];
          tmp_y = tmp_gen.centroid()[1];
  
          if (nodeList.length !== 0) {
            var distanceCheck = 0;
            for (l = 0; l < nodeList.length; l++) {
              distance = Math.sqrt(
                Math.pow(nodeList[l][0] - tmp_x, 2) +
                  Math.pow(nodeList[l][1] - tmp_y, 2)
              );
              if (distance <= 2) {
                distanceCheck = 1;
              }
            }
            if (distanceCheck === 1) {
              return assignRandom(
                tmp_startAngleMin,
                tmp_endAngleMax,
                tmp_innerRadiusMin,
                tmp_outerRadiusMax,
                congestion,
                nodeList
              );
            } else {
              nodeList.push([tmp_x, tmp_y]);
              return [tmp_x, tmp_y];
            }
          } else {
            nodeList.push([tmp_x, tmp_y]);
            return [tmp_x, tmp_y];
          }
        }
        function projectPoint(x, y) {
        var point = map.latLngToLayerPoint(new L.LatLng(y, x));
        this.stream.point(point.x, point.y);
      }

      var center = function (arr)
        {
            var minX, maxX, minY, maxY;
            for (var i = 0; i < arr.length; i++)
            {
                minX = (arr[i][0] < minX || minX == null) ? arr[i][0] : minX;
                maxX = (arr[i][0] > maxX || maxX == null) ? arr[i][0] : maxX;
                minY = (arr[i][1] < minY || minY == null) ? arr[i][1] : minY;
                maxY = (arr[i][1] > maxY || maxY == null) ? arr[i][1] : maxY;
            }
            return [(minX + maxX) / 2, (minY + maxY) / 2];
        }


      </script>
  
  </body>
</html>
